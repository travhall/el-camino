---
// src/components/ArticleCard.astro - Fixed with all variants preserved from _BU
import type {
  WordPressPost,
  ExtractedWordPressData,
  WordPressFallbackContent,
} from "@/lib/wordpress/types";
import {
  getDisplayCategory,
  extractEmbeddedData,
  generateFallbackContent,
} from "@/lib/wordpress/types";
import { formatDate } from "@/utils/dates";
import {
  EL_CAMINO_LOGO_DATA_URI,
  EL_CAMINO_LOADER_DATA_URI,
} from "@/lib/constants/assets";
import { EnhancedImageOptimizer } from "@/lib/image/enhanced-optimizer";
import Tag from "./Tag.astro";

interface Props {
  post: WordPressPost;
  featured?: boolean;
  priority?: boolean;
  // OPTIMIZED: Make these optional and compute lazily if not provided
  embeddedData?: ExtractedWordPressData;
  fallbackContent?: WordPressFallbackContent;
  // New props for different layouts
  variant?: "masonry" | "grid" | "list";
  // Animation props (passed through for entrance animations)
  "data-initial-index"?: number;
  "data-variant"?: string;
}

const {
  post,
  featured = false,
  priority = false,
  embeddedData,
  fallbackContent,
  variant = "masonry",
} = Astro.props;

// Only apply animation wrapper classes for masonry (home page)
// Grid/list variants use a wrapper div for animation
const shouldAnimate = variant === "masonry";

// OPTIMIZED: Lazy computation - only process if not provided
const actualEmbeddedData = embeddedData || extractEmbeddedData(post);
const actualFallbackContent = fallbackContent || generateFallbackContent(post);

const imageUrl = actualEmbeddedData.featuredMedia?.source_url || "";

// Image dimensions based on variant and card type
const getImageDimensions = () => {
  switch (variant) {
    case "list":
      return { width: 160, height: 120 };
    case "grid":
      return { width: 400, height: 240 };
    case "masonry":
    default:
      return { width: featured ? 800 : 600, height: featured ? 533 : 400 };
  }
};

const { width: imageWidth, height: imageHeight } = getImageDimensions();

// Enhanced image optimization - Generate all formats like ProductCard
let optimizedImageUrl = "";
let avifSrcSet: string | undefined;
let webpSrcSet: string | undefined;
let jpegSrcSet: string | undefined;
let imageSizes =
  variant === "list"
    ? "(max-width: 768px) 0px, 256px"
    : "(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw";

if (imageUrl) {
  const imageSet = EnhancedImageOptimizer.generateOptimizedSources(imageUrl, {
    width: imageWidth,
    height: imageHeight,
    quality: 85,
    priority: priority,
  });

  optimizedImageUrl = imageSet.avif || imageSet.webp || imageSet.jpeg;

  // Generate responsive srcset for each format
  avifSrcSet = imageSet.avif
    ? EnhancedImageOptimizer.generateResponsiveSrcSet(imageUrl, "avif", {
        width: imageWidth,
        height: imageHeight,
        quality: 85,
      })
    : undefined;

  webpSrcSet = imageSet.webp
    ? EnhancedImageOptimizer.generateResponsiveSrcSet(imageUrl, "webp", {
        width: imageWidth,
        height: imageHeight,
        quality: 85,
      })
    : undefined;

  jpegSrcSet = EnhancedImageOptimizer.generateResponsiveSrcSet(
    imageUrl,
    "jpeg",
    {
      width: imageWidth,
      height: imageHeight,
      quality: 85,
    }
  );
}

// Get the proper display category
const displayCategory = getDisplayCategory(post);

// Extract tags for display (show all tags, let them wrap)
const displayTags = actualEmbeddedData.tags;

// Define CSS classes based on variant
const getCardClasses = () => {
  const baseClasses =
    "relative overflow-hidden bg-(--ui-card-surface) hover:bg-(--ui-card-surface-hover) text-(--ui-card-text) border-(--ui-card-border) min-h-full group";

  switch (variant) {
    case "list":
      return `${baseClasses} flex flex-row gap-4 p-1 transition-all duration-300`;

    case "grid":
      return `${baseClasses} flex flex-col p-1 transition-all duration-300`;

    case "masonry":
    default:
      return `${baseClasses} flex flex-col aspect-[3/4.5] md:aspect-auto col-span-full md:first-of-type:col-span-4 md:col-span-2 md:row-span-5 md:first-of-type:row-span-4 2xl:row-span-4 2xl:first-of-type:row-span-3 ${
        featured
          ? "banner-card contain-layout"
          : "article-card transition-all duration-300"
      }`;
  }
};

const getImageContainerClasses = () => {
  switch (variant) {
    case "list":
      // FIX: Hide entire image container on mobile, not just the image
      return "hidden md:flex flex-shrink-0 overflow-hidden relative";

    case "grid":
      return "overflow-hidden relative h-48 relative";

    case "masonry":
    default:
      return "w-full h-full relative";
  }
};

const getImageClasses = () => {
  const baseClasses = "object-cover transition-all duration-300";

  switch (variant) {
    case "list":
      // FIX: Container is hidden on mobile, so image just needs responsive width
      return `${baseClasses} w-full md:w-64 lg:w-72 h-full aspect-video group-hover:scale-105`;

    case "grid":
      return `${baseClasses} w-full h-48 group-hover:scale-105`;

    case "masonry":
    default:
      return `${baseClasses} w-full h-full ${
        featured
          ? "opacity-90 lg:group-hover:scale-105"
          : "opacity-10 lg:group-hover:scale-105 lg:group-hover:opacity-95"
      }`;
  }
};

const getContentClasses = () => {
  switch (variant) {
    case "list":
      return "flex flex-col p-4 flex-1 min-w-0 gap-2";

    case "grid":
      return "flex flex-col p-4 flex-1 gap-2 h-auto";

    case "masonry":
    default:
      return `flex flex-col gap-2 px-6 py-12 xl:p-12 absolute bottom-0 m-1 bg-(--ui-card-surface)/00 lg:group-hover:bg-(--ui-card-surface)/100 transition-all duration-300 ${
        featured &&
        "bg-(--ui-card-surface)/90 md:bg-(--ui-card-surface) first-of-type:m-0 md:border-t-4 md:border-l-4 md:border-(--ui-card-border) md:w-5/6 lg:w-2/3 right-0"
      }`;
  }
};

const getTitleClasses = () => {
  switch (variant) {
    case "list":
      return "font-display font-bold text-3xl lg:text-4xl leading-[0.8] text-(--content-heading) line-clamp-2";

    case "grid":
      return "font-display font-bold text-3xl lg:text-4xl leading-[0.8] text-(--content-heading) line-clamp-2";

    case "masonry":
    default:
      return "font-display font-black text-6xl lg:text-5xl xl:text-6xl 2xl:text-7xl leading-[0.8] text-(--content-heading) mb-2";
  }
};

const getExcerptClasses = () => {
  switch (variant) {
    case "list":
      return "text-sm leading-snug text-(--content-body) line-clamp-2 mb-2 max-w-[72ch]";

    case "grid":
      return "text-sm leading-snug text-(--content-body) line-clamp-3 mb-2";

    case "masonry":
    default:
      return `text-sm md:text-base leading-snug text-(--content-body) mb-2 ${
        featured ? "line-clamp-3 md:line-clamp-2" : "line-clamp-3"
      }`;
  }
};
---

<a
  href={`/news/${post.slug}`}
  class={`${getCardClasses()} ${shouldAnimate ? 'article-card-wrapper opacity-0' : ''}`}
  aria-label={`Read article: ${actualFallbackContent.title}`}
  data-initial-index={shouldAnimate ? Astro.props["data-initial-index"] : undefined}
  data-variant={shouldAnimate ? Astro.props["data-variant"] || variant : undefined}
>
  <!-- Enhanced Image with AVIF/WebP support -->
  {
    optimizedImageUrl ? (
      <picture class={getImageContainerClasses()}>
        {/* Loading placeholder - only for images that will load */}
        <div
          class="loading-skeleton loading-image absolute inset-0 w-full h-full"
          id={`article-placeholder-${post.id}`}
          aria-hidden="true"
        >
          <div
            class="absolute inset-0 flex items-center justify-center h-full"
            style={`background-image: url('${EL_CAMINO_LOADER_DATA_URI}'); background-size: auto; background-position: center; background-repeat: no-repeat; opacity: 0.7;`}
          />
        </div>

        {/* AVIF format (best compression) */}
        {avifSrcSet && (
          <source type="image/avif" srcset={avifSrcSet} sizes={imageSizes} />
        )}

        {/* WebP format (good compression) */}
        {webpSrcSet && (
          <source type="image/webp" srcset={webpSrcSet} sizes={imageSizes} />
        )}

        {/* JPEG fallback */}
        <img
          src={optimizedImageUrl}
          srcset={jpegSrcSet}
          sizes={imageSizes}
          alt={actualFallbackContent.imageAlt}
          width={imageWidth}
          height={imageHeight}
          class={`${getImageClasses()} opacity-0`}
          loading={priority ? "eager" : "lazy"}
          fetchpriority={priority ? "high" : "auto"}
          decoding={priority ? "sync" : "async"}
          data-placeholder-id={`article-placeholder-${post.id}`}
          onload={
            variant === "masonry" && !featured
              ? `this.style.opacity=''; this.classList.add('loaded'); document.getElementById('article-placeholder-${post.id}')?.remove();`
              : `this.style.opacity='1'; this.classList.add('loaded'); document.getElementById('article-placeholder-${post.id}')?.remove();`
          }
          onerror={
            variant === "masonry" && !featured
              ? `this.src='${EL_CAMINO_LOGO_DATA_URI}'; this.style.opacity=''; this.classList.add('error'); document.getElementById('article-placeholder-${post.id}')?.remove();`
              : `this.src='${EL_CAMINO_LOGO_DATA_URI}'; this.style.opacity='1'; this.classList.add('error'); document.getElementById('article-placeholder-${post.id}')?.remove();`
          }
        />
      </picture>
    ) : (
      <img
        src={EL_CAMINO_LOGO_DATA_URI}
        alt="Article placeholder"
        width={imageWidth}
        height={imageHeight}
        class={getImageClasses()}
        loading={priority ? "eager" : "lazy"}
        fetchpriority={priority ? "high" : "auto"}
        decoding={priority ? "sync" : "async"}
      />
    )
  }

  <!-- Content Container - Layout preserved from _BU -->
  <div class={getContentClasses()}>
    <!-- Category Badge -->
    <span
      class="font-display font-bold tracking-wide uppercase text-(--ui-button-text) bg-(--ui-button-surface) px-2 py-0.5 rounded-xs mb-2 self-start leading-none"
    >
      {displayCategory}
    </span>

    <!-- Article Title -->
    <h2 class={getTitleClasses()} set:html={post.title.rendered} />

    <!-- Date  -->
    <time datetime={post.date} class="text-xs text-(--content-meta) mb-1">
      {formatDate(post.date)}
    </time>

    <!-- Article Excerpt -->
    <div class={getExcerptClasses()} set:html={post.excerpt.rendered} />

    <!-- Read More Link ('masonry' cards only) -->
    {
      variant === "masonry" && (
        <div class="overflow-hidden">
          <span class="font-display lg:-ml-[100%] lg:group-hover:ml-0 py-2 self-start text-2xl text-(--ui-button-surface) font-semibold transition-all duration-200">
            Read More
          </span>
        </div>
      )
    }

    <!-- Article Tags (let them wrap naturally) -->
    {
      displayTags.length > 0 && (
        <div class="flex flex-wrap gap-2 mt-auto pt-2 items-center">
          {displayTags.map((tag) => (
            <Tag
              tag={tag}
              variant="default"
              size="sm"
              clickable={true}
              useButton={true}
            />
          ))}
        </div>
      )
    }
  </div>
</a>

<script>
  // SIMPLIFIED: Streamlined script based on working ProductCard pattern
  document.addEventListener("astro:page-load", () => {
    // Client-side fallback for failed images
    const images = document.querySelectorAll<HTMLImageElement>(
      "img[src*='wordpress'], img[src*='gravatar']"
    );

    images.forEach((img) => {
      img.addEventListener("error", () => {
        if (img.classList.contains("w-8")) {
          img.style.display = "none";
        } else {
          img.style.opacity = "0.5";
          img.alt = "Article image not available";
        }
      });
    });

    // Simplified intersection observer for analytics
    if ("IntersectionObserver" in window) {
      const articleCards = document.querySelectorAll(
        "a[class*='article-'], a[class*='banner-card']"
      );

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              const card = entry.target as HTMLElement;
              const articleTitle = card
                .querySelector("h2")
                ?.textContent?.trim();

              if (
                articleTitle &&
                typeof window !== "undefined" &&
                (window as any).gtag
              ) {
                (window as any).gtag("event", "article_impression", {
                  article_title: articleTitle,
                  position: Array.from(
                    card.parentElement?.children || []
                  ).indexOf(card),
                });
              }

              observer.unobserve(card);
            }
          });
        },
        { threshold: 0.5, rootMargin: "0px 0px -100px 0px" }
      );

      articleCards.forEach((card) => {
        observer.observe(card);
      });
    }
  });
</script>
