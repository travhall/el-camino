---
// src/components/MiniCart.astro
import { Icon } from "astro-icon/components";
---

<style>
  @keyframes shimmer {
    0% {
      background-position: -200% 0;
    }
    100% {
      background-position: 200% 0;
    }
  }
  
  .loading-skeleton {
    background: linear-gradient(
      90deg,
      #f0f0f0 25%,
      #e0e0e0 50%,
      #f0f0f0 75%
    );
    background-size: 200% 100%;
    animation: shimmer 1.5s ease-in-out infinite;
  }
</style>

<!-- Overlay -->
<div
  id="mini-cart-overlay"
  class="fixed inset-0 bg-(--ui-modal-overlay)/80 backdrop-blur-sm z-50 hidden opacity-0 transition-opacity duration-300"
>
</div>

<!-- Slide Panel -->
<div
  id="mini-cart-panel"
  class="fixed top-0 right-0 h-screen w-96 max-w-full bg-(--surface-primary) border-4 border-(--surface-primary) z-50 transform translate-x-full transition-transform duration-300 shadow-lg overflow-y-scroll"
  role="dialog"
  aria-labelledby="mini-cart-title"
>
  <div class="container grid grid-rows-[auto_1fr_auto] h-full">
    <!-- Header -->
    <div
      class="flex items-center justify-between p-4 border-b-4 border-(--border-secondary) bg-(--surface-secondary) sticky top-0"
    >
      <h2
        id="mini-cart-title"
        class="font-display text-xl text-(--content-heading)"
      >
        Cart (<span id="mini-cart-count">0</span>)
      </h2>
      <button
        id="close-mini-cart"
        type="button"
        class="p-2 hover:border-(--ui-nav-border) border rounded-sm transition-colors"
        aria-label="Close cart"
      >
        <Icon name="uil:times" class="w-6 h-6" />
      </button>
    </div>

    <!-- Content Area -->
    <div id="mini-cart-content" class="flex-1 overflow-y-auto">
      <div
        id="mini-cart-loading"
        class="text-center py-8 h-full place-content-center"
      >
        <div
          class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-(--content-heading)"
        >
        </div>
        <p class="mt-2 text-(--content-meta)">Loading cart...</p>
      </div>

      <div
        id="mini-cart-empty"
        class="text-center py-8 px-4 h-full place-content-center hidden"
      >
        <Icon
          name="uil:shopping-cart"
          class="w-16 h-16 mx-auto text-(--content-meta) mb-4"
        />
        <p class="text-(--content-meta) mb-2">Your cart is empty</p>
        <button
          id="continue-shopping"
          class="font-sans font-semibold text-sm lg:text-base py-2 px-3 lg:py-2 lg:px-4 border-2 rounded-[4px] text-(--ui-button-text) bg-(--ui-button-surface) border-(--ui-button-border) hover:bg-(--ui-button-surface)/75 outline-0 focus-visible:ring focus-visible:ring-offset-2 focus-visible:ring-(--ui-button-ring) transition-all ease-in-out duration-300"
        >
          Continue Shopping
        </button>
      </div>

      <div id="mini-cart-items" class="hidden">
        <div class="space-y-1" id="items-list">
          <!-- Items with controls populated here -->
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div
      id="mini-cart-footer"
      class="border-t-4 border-(--border-secondary) bg-(--surface-secondary) p-4 sticky bottom-0 hidden"
    >
      <div class="flex justify-between items-start mb-4">
        <span class="font-medium text-(--content-heading)">Subtotal:</span>
        <span
          id="mini-cart-total"
          class="font-display text-3xl text-(--content-heading)">$0.00</span
        >
      </div>

      <div class="space-y-2">
        <button
          id="mini-cart-checkout"
          class="w-full font-sans font-semibold text-sm text-center lg:text-base py-2 px-3 lg:py-2 lg:px-4 border-2 rounded-[4px] text-(--ui-button-text) bg-(--ui-button-surface) border-(--ui-button-border) hover:bg-(--ui-button-surface)/75 outline-0 focus-visible:ring focus-visible:ring-offset-2 focus-visible:ring-(--ui-button-ring) transition-all ease-in-out duration-300"
          disabled
        >
          <span class="checkout-text">Proceed to Checkout</span>
          <div class="checkout-loading hidden">
            <div
              class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-current mr-2"
            >
            </div>
            Processing...
          </div>
        </button>
        <button
          id="view-full-cart"
          class="w-full font-sans font-semibold text-sm text-center lg:text-base py-2 px-3 lg:py-2 lg:px-4 border-2 rounded-[4px] text-(--ui-button-surface) border-(--ui-button-border) bg-(--ui-button-surface)/0 hover:bg-(--ui-button-surface)/20 outline-0 focus-visible:ring focus-visible:ring-offset-2 focus-visible:ring-(--ui-button-ring) transition-all ease-in-out duration-300"
        >
          View Full Cart
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  import type { CartItem } from "@/lib/cart/types";
  import { createSlug } from "@/lib/square/slugUtils";

  let cart: any = null;
  let inventoryData: Record<string, number> = {};

  async function loadCart() {
    if (!cart) {
      const module = await import("@/lib/cart");
      cart = module.cart;
    }
    return cart;
  }

  function formatPrice(price: number): string {
    return new Intl.NumberFormat("en-US", {
      style: "currency",
      currency: "USD",
    }).format(price);
  }

  function showNotification(
    message: string,
    type: "success" | "error" = "success"
  ): void {
    // Use existing system if available
    if (typeof window !== "undefined" && (window as any).showNotification) {
      (window as any).showNotification(message, type);
      return;
    }

    // Fallback (should not be needed but kept for safety)
    const notification = document.createElement("div");
    notification.className = `fixed top-4 right-4 z-70 px-4 py-2 rounded-sm text-white transform translate-x-full transition-transform duration-300 ${
      type === "success" ? "bg-green-600" : "bg-red-600"
    }`;
    notification.textContent = message;

    document.body.appendChild(notification);
    requestAnimationFrame(() =>
      notification.classList.remove("translate-x-full")
    );

    setTimeout(() => {
      notification.classList.add("translate-x-full");
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  async function handleCheckout(): Promise<void> {
    const checkoutButton = document.getElementById(
      "mini-cart-checkout"
    ) as HTMLButtonElement;
    const checkoutText = document.querySelector(
      ".checkout-text"
    ) as HTMLElement;
    const checkoutLoading = document.querySelector(
      ".checkout-loading"
    ) as HTMLElement;

    if (!checkoutButton || !checkoutText || !checkoutLoading) return;

    try {
      const cartInstance = await loadCart();
      const items = cartInstance.getItems();

      if (items.length === 0) {
        showNotification("Your cart is empty", "error");
        return;
      }

      checkoutButton.disabled = true;
      checkoutText.classList.add("hidden");
      checkoutLoading.classList.remove("hidden");

      const response = await fetch("/api/create-checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ items }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error?.message || "Checkout failed");
      }

      if (!data.checkoutUrl) {
        throw new Error("No checkout URL returned");
      }

      showNotification("Redirecting to checkout...", "success");
      window.location.href = data.checkoutUrl;
    } catch (error) {
      console.error("Checkout error:", error);
      showNotification(
        error instanceof Error
          ? error.message
          : "Checkout failed. Please try again.",
        "error"
      );

      checkoutButton.disabled = false;
      checkoutText.classList.remove("hidden");
      checkoutLoading.classList.add("hidden");
    }
  }

  function renderCartItem(item: CartItem): string {
    const itemKey = `${item.id}:${item.variationId}`;
    const inventory = inventoryData[item.variationId] || 999;
    const isOutOfStock = inventory <= 0;
    const isLowStock = inventory > 0 && inventory <= 5;
    const maxQuantity = Math.min(inventory, 99);

    // Generate proper slug from product title
    const productSlug = createSlug(item.title);
    const productUrl = `/product/${productSlug}`;

    return `
    <div class="flex gap-3 p-3 border border-ui-border bg-(--surface-secondary) rounded-sm" data-item-key="${itemKey}">
      <div class="relative w-16 h-16">
        ${
          item.image
            ? `
          <!-- Shimmer loading placeholder -->
          <div 
            class="loading-skeleton absolute inset-0 rounded-sm animate-pulse bg-gradient-to-r from-gray-200 via-gray-100 to-gray-200 bg-[length:200%_100%]"
            id="mini-cart-placeholder-${itemKey}"
            style="animation: shimmer 1.5s ease-in-out infinite;"
          >
            <!-- El Camino logo as loading indicator -->
            <div 
              class="absolute inset-0 flex items-center justify-center rounded-sm opacity-70"
              style="background-image: url('data:image/svg+xml,%3Csvg%20width%3D%2236%22%20height%3D%2232%22%20viewBox%3D%220%200%2036%2032%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20clip-rule%3D%22evenodd%22%20d%3D%22M8.014%2032h-.07a13%2013%200%200%201-3.455-.456c-1.567-.441-2.468-1.263-2.644-1.422-.174-.163-1.064-.992-1.549-2.493-.484-1.502-.238-3.252-.198-3.533.278-1.982.967-3.164%201.113-3.415a7.8%207.8%200%200%201%202.137-2.355c.213-.152%201.304-.932%202.996-1.374.287-.074%201.702-.441%203.695-.441%201.225%200%202.01.096%202.184.118.97.117%201.597.262%201.734.294.764.177%201.23.361%201.334.402l1.031.422-.635%204.514h-3.124c-.43-.706-.933-.982-1.038-1.04-.596-.334-1.175-.334-1.281-.334-.095%200-.581%200-1.162.216a3.7%203.7%200%200%200-1.054.628c-.08.069-.483.413-.827%201.011-.058.1-.342.59-.45%201.354-.02.149-.177%201.263-.034%201.871.142.609.46.935.523%201.001.064.065.391.393.998.58l.723.146%201.135.03c.17-.005%201.092-.039%202.112-.163%204.23-.714%205.213-4.63%205.708-5.675l.1-.233a8%208%200%200%201%201.206-1.933l.002-.004c.212-.26%201.31-1.615%203.531-2.392l.132-.048a13%2013%200%200%201%202.303-.579c.199-.03%201.22-.186%202.507-.186h.01c1.282%200%202.251.155%202.445.186%201.168.187%201.986.513%202.15.58a6.9%206.9%200%200%201%201.739%201c.12.096.765.608%201.249%201.453.448.782.603%201.773.628%201.933.03.192.172%201.087-.007%202.433-.285%202.149-1.053%203.378-1.218%203.64a8.4%208.4%200%200%201-2.34%202.474%209.5%209.5%200%200%201-3.152%201.374c-.289.066-1.81.416-3.682.416-.194%200-1.153%200-2.427-.161a8.5%208.5%200%200%201-2.134-.55%207%207%200%200%201-1.734-1.03l-.605-.595c-3%201.746-7.412%202.136-8.082%202.195-.2.018-1.476.134-2.514.14zm17.908-10.838c-.469.157-.75.378-.807.422-.328.265-.497.545-.53.599l-.334.677-.177.667-.09.57-.07.568-.012.678.142.686c.017.055.107.344.36.619.044.045.263.265.686.431.082.032.433.167%201.098.167.664%200%201.048-.136%201.134-.167.48-.166.76-.386.818-.431.34-.275.51-.562.544-.619.215-.344.315-.63.335-.686l.179-.678.1-.569.06-.569.01-.667a2.6%202.6%200%200%200-.143-.677c-.018-.053-.109-.334-.373-.599-.045-.046-.264-.265-.698-.422-.082-.032-.423-.167-1.087-.167-.665%200-1.058.137-1.145.167m-14.92-8.684c2.667%200%204.174-.902%204.48-1.365h1.782l-.616%204.376H2.386L3%2011.113l1.4-.252.874-6.212-1.33-.252L4.563%200h14.263l-.615%204.377h-1.718c-.235-.39-1.746-1.365-4.16-1.365l-.508%203.613%203.292-.655-.502%203.57-3.108-.656zm16.37-.777c.47.007%204.464.06%205.687-1.375h1.796l-.726%205.163H17.726l.615-4.376%201.401-.252.874-6.212-1.328-.272L19.904%200h10.48l-.616%204.377-1.404.272z%22%20fill%3D%22%2359564F%22%20fill-opacity%3D%22.7%22%2F%3E%3C%2Fsvg%3E'); background-size: 20px 18px; background-position: center; background-repeat: no-repeat;"
            ></div>
          </div>
          
          <!-- Optimized product image -->
          <img 
            src="${item.image}" 
            alt="${item.title}"
            class="w-16 h-16 object-cover rounded-sm bg-(--surface-secondary) opacity-0 transition-opacity duration-300"
            loading="lazy"
            onload="this.style.opacity='1'; document.getElementById('mini-cart-placeholder-${itemKey}')?.remove();"
            onerror="this.src='data:image/svg+xml,%3Csvg%20width%3D%2248%22%20height%3D%2244%22%20viewBox%3D%220%200%2048%2044%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Crect%20width%3D%2248%22%20height%3D%2244%22%20fill%3D%22white%22%20fill-opacity%3D%220.7%22%2F%3E%3Cpath%20fill-rule%3D%22evenodd%22%20clip-rule%3D%22evenodd%22%20d%3D%22M12.904%2039.9998L12.827%2040C10.7973%2040%209.28558%2039.5717%208.98823%2039.4875C7.2466%2038.9908%206.24507%2038.0664%206.05024%2037.8868C5.85673%2037.7041%204.86739%2036.7717%204.32907%2035.0827C3.79098%2033.393%204.06438%2031.424%204.10835%2031.1083C4.41789%2028.8789%205.18323%2027.5482%205.34541%2027.2665C6.28447%2025.6546%207.48735%2024.7851%207.72026%2024.617C7.95644%2024.4461%209.16912%2023.5682%2011.049%2023.0713C11.3683%2022.9875%2012.9403%2022.5746%2015.1546%2022.5746C16.5158%2022.5746%2017.3886%2022.6832%2017.5815%2022.7072C18.6588%2022.8396%2019.3555%2023.0028%2019.5075%2023.0382C20.3568%2023.2372%2020.8753%2023.4448%2020.9903%2023.4909L22.1355%2023.9657C21.9004%2025.6583%2021.6653%2027.3511%2021.4303%2029.0439H17.9585C17.4809%2028.2493%2016.9223%2027.9384%2016.8061%2027.8736C16.1433%2027.4983%2015.5003%2027.4983%2015.3821%2027.4983C15.2767%2027.4983%2014.7362%2027.4983%2014.0913%2027.7413C13.9885%2027.7807%2013.4576%2027.9843%2012.9203%2028.4478C12.8311%2028.5247%2012.3829%2028.9116%2012.0013%2029.5847C11.9369%2029.6968%2011.6208%2030.2474%2011.5013%2031.1083C11.478%2031.2752%2011.3041%2032.5284%2011.4628%2033.2133C11.6213%2033.8974%2011.9737%2034.2651%2012.0446%2034.3393C12.1158%2034.4118%2012.4791%2034.7808%2013.1537%2034.9906L13.9563%2035.1554L15.2175%2035.1904C15.4058%2035.1835%2016.431%2035.1461%2017.5641%2035.0065C22.2646%2034.2029%2023.3571%2029.7977%2023.9069%2028.6215L24.0171%2028.3595C24.5561%2027.1344%2025.2245%2026.3417%2025.3573%2026.1846L25.3606%2026.1806C25.5954%2025.8873%2026.8158%2024.3632%2029.2838%2023.4893L29.4298%2023.4357C29.6279%2023.3638%2030.6452%2022.994%2031.9888%2022.7844C32.2096%2022.7503%2033.3443%2022.5746%2034.7747%2022.5746H34.786C36.2098%2022.5754%2037.2871%2022.7496%2037.5022%2022.7844C38.7998%2022.9942%2039.7083%2023.3617%2039.8914%2023.4357C40.9837%2023.8774%2041.6851%2024.4495%2041.8228%2024.5618C41.9576%2024.6701%2042.6738%2025.2462%2043.2108%2026.1956C43.7088%2027.0762%2043.8808%2028.1905%2043.9086%2028.3705C43.9426%2028.5869%2044.1002%2029.5933%2043.9014%2031.1083C43.5843%2033.5256%2042.7306%2034.9081%2042.5479%2035.204C41.5044%2036.9042%2040.1994%2037.8105%2039.9469%2037.986C39.6973%2038.1595%2038.3898%2039.0678%2036.4452%2039.5317C36.1249%2039.6062%2034.4344%2040%2032.3546%2040C32.1384%2040%2031.0728%2040%2029.6578%2039.8188C28.3773%2039.6531%2027.4671%2039.2752%2027.2868%2039.2004C26.2078%2038.7479%2025.4973%2038.1557%2025.3599%2038.0412L24.6875%2037.3722C21.3547%2039.3369%2016.4519%2039.7748%2015.7077%2039.8414C15.4848%2039.8619%2014.0673%2039.9923%2012.9147%2039.9998H12.904ZM32.8021%2027.8074C32.2814%2027.9843%2031.9688%2028.2322%2031.9057%2028.2822C31.5413%2028.5803%2031.3528%2028.8947%2031.3163%2028.9555L30.9453%2029.7173L30.7488%2030.4681L30.6482%2031.1083L30.5709%2031.7486L30.5574%2032.5103L30.7153%2033.2832C30.7339%2033.3441%2030.8345%2033.6693%2031.1147%2033.9787C31.1649%2034.0297%2031.4077%2034.2766%2031.8776%2034.4643C31.9693%2034.4999%2032.3589%2034.652%2033.0973%2034.652C33.8354%2034.652%2034.2618%2034.4987%2034.3574%2034.4643C34.8907%2034.2768%2035.2028%2034.0295%2035.2671%2033.9787C35.6443%2033.6695%2035.8341%2033.3461%2035.8711%2033.2832C36.1097%2032.8959%2036.2213%2032.5748%2036.2438%2032.5103L36.4418%2031.7486L36.5538%2031.1083L36.6197%2030.4681L36.6317%2029.7173C36.6273%2029.6553%2036.6047%2029.3318%2036.4721%2028.9555C36.4528%2028.8957%2036.3511%2028.5801%2036.0581%2028.2822C36.0076%2028.2307%2035.7647%2027.984%2035.2818%2027.8074C35.1915%2027.7713%2034.8119%2027.6198%2034.074%2027.6198C33.3356%2027.6198%2032.8988%2027.7734%2032.8021%2027.8074ZM16.2243%2018.0371C19.1879%2018.0371%2020.8618%2017.0233%2021.2023%2016.5018H23.1817C22.9538%2018.1432%2022.7258%2019.7843%2022.4979%2021.4254H6.6506C6.87851%2019.7843%207.10642%2018.1432%207.33433%2016.5018L8.89093%2016.2182C9.2144%2013.8888%209.53787%2011.5593%209.86133%209.23003L8.38374%208.94627C8.61252%207.29765%208.84152%205.64882%209.07052%204H24.9178C24.6899%205.64133%2024.462%207.28244%2024.2341%208.92377H22.3258C22.0638%208.48625%2020.3852%207.38828%2017.7032%207.38828C17.5148%208.74334%2017.3268%2010.0984%2017.1385%2011.4535C18.3579%2011.2076%2019.5773%2010.962%2020.7968%2010.7161C20.6108%2012.0547%2020.425%2013.3934%2020.2391%2014.7322C19.088%2014.4863%2017.9368%2014.2404%2016.7857%2013.9947C16.5984%2015.3422%2016.4113%2016.6898%2016.2243%2018.0371ZM34.4142%2017.164C34.9358%2017.171%2039.3738%2017.2315%2040.7318%2015.617H42.7278C42.4589%2017.5531%2042.1901%2019.4892%2041.9213%2021.4254H23.6953C23.9233%2019.7843%2024.1512%2018.1432%2024.3791%2016.5018L25.9357%2016.2182C26.2592%2013.8888%2026.5826%2011.5593%2026.9061%209.23003L25.4316%208.92356C25.6594%207.28244%2025.8873%205.64133%2026.1153%204H37.7597C37.5318%205.64133%2037.3038%207.28244%2037.0759%208.92356L35.5161%209.23003C35.1488%2011.8745%2034.7814%2014.5192%2034.4142%2017.164Z%22%20fill%3D%22%2359564F%22%20fill-opacity%3D%220.7%22%2F%3E%3C%2Fsvg%3E'; this.style.opacity='1'; document.getElementById('mini-cart-placeholder-${itemKey}')?.remove();"
          />
        `
            : `
          <!-- No image fallback with El Camino logo -->
          <div class="w-16 h-16 bg-(--surface-secondary) rounded-sm flex items-center justify-center">
            <svg class="w-8 h-8 text-(--content-meta)" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
            </svg>
          </div>
        `
        }
      </div>

      <div class="flex-1 min-w-0">
        <h3 class="font-medium text-(--content-heading) text-sm leading-tight line-clamp-2">
          <a 
            href="${productUrl}" 
            class="hover:text-(--content-emphasis) transition-colors product-link"
            data-product-url="${productUrl}"
          >
          ${item.title}
          </a>
        </h3>

        ${
          item.variationName
            ? `
          <p class="text-xs text-(--content-meta) mt-1">${item.variationName}</p>
        `
            : ""
        }

        <div class="flex items-center justify-between mt-2">
          <div class="flex items-center gap-2">
            <span class="text-sm font-medium text-(--content-heading)">
              ${formatPrice(item.price)}
            </span>
            ${item.unit ? `<span class="text-xs text-(--content-meta)">${item.unit}</span>` : ""}
          </div>

          <!-- Quantity Controls -->
          <div class="flex items-center gap-1">
            <button
              class="w-6 h-6 flex items-center justify-center border border-ui-border rounded-sm hover:bg-(--ui-button-surface) transition-colors ${
                item.quantity <= 1 ? "opacity-50" : ""
              }"
              data-action="decrease"
              data-item-key="${itemKey}"
              ${item.quantity <= 1 ? "disabled" : ""}
              aria-label="Decrease quantity"
            >
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
              </svg>
            </button>

            <span class="w-8 text-center text-sm font-medium">${item.quantity}</span>

            <button
              class="w-6 h-6 flex items-center justify-center border border-ui-border rounded-sm hover:bg-(--ui-button-surface) transition-colors ${
                item.quantity >= maxQuantity ? "opacity-50" : ""
              }"
              data-action="increase"
              data-item-key="${itemKey}"
              ${item.quantity >= maxQuantity ? "disabled" : ""}
              aria-label="Increase quantity"
            >
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
              </svg>
            </button>
          </div>
        </div>

        <div class="flex items-center justify-between mt-2">
          <!-- Stock status -->
          <div class="text-xs">
            ${
              isOutOfStock
                ? `<span class="text-red-600 font-medium">Out of Stock</span>`
                : isLowStock
                  ? `<span class="text-amber-600 font-medium">Only ${inventory} left</span>`
                  : ""
            }
          </div>

          <!-- Remove button -->
          <button
            class="text-xs font-semibold relative hover:text-ui-nav-hover before:absolute before:-bottom-0.5 before:left-0 before:w-full before:h-0.5 before:bg-(--ui-nav-hover) before:transform before:scale-x-0 before:origin-right before:transition-transform before:duration-300 before:ease-in-out hover:before:scale-x-100 hover:before:origin-left"
            data-action="remove"
            data-item-key="${itemKey}"
            data-item-title="${item.title}"
          >
            Remove
          </button>
        </div>
      </div>
    </div>
  `;
  }

  async function loadInventoryData(items: CartItem[]): Promise<void> {
    if (items.length === 0) return;

    try {
      const variationIds = items.map((item) => item.variationId);
      const response = await fetch("/api/cart-inventory", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ variationIds }),
      });

      if (response.ok) {
        const data = await response.json();
        inventoryData = data.inventory || {};
      }
    } catch (error) {
      console.warn("Failed to load inventory data:", error);
    }
  }

  async function updateMiniCartDisplay(): Promise<void> {
    const loadingEl = document.getElementById("mini-cart-loading");
    const emptyEl = document.getElementById("mini-cart-empty");
    const itemsEl = document.getElementById("mini-cart-items");
    const footerEl = document.getElementById("mini-cart-footer");
    const countEl = document.getElementById("mini-cart-count");
    const totalEl = document.getElementById("mini-cart-total");
    const itemsListEl = document.getElementById("items-list");
    const checkoutButton = document.getElementById(
      "mini-cart-checkout"
    ) as HTMLButtonElement;

    if (
      !loadingEl ||
      !emptyEl ||
      !itemsEl ||
      !footerEl ||
      !countEl ||
      !totalEl ||
      !itemsListEl
    ) {
      console.error("Mini cart elements not found");
      return;
    }

    try {
      const cartInstance = await loadCart();
      const items = cartInstance.getItems();
      const total = cartInstance.getTotal();
      const count = cartInstance.getItemCount();

      await loadInventoryData(items);

      countEl.textContent = count.toString();
      loadingEl.classList.add("hidden");

      if (items.length === 0) {
        emptyEl.classList.remove("hidden");
        itemsEl.classList.add("hidden");
        footerEl.classList.add("hidden");
        if (checkoutButton) checkoutButton.disabled = true;
      } else {
        emptyEl.classList.add("hidden");
        itemsEl.classList.remove("hidden");
        footerEl.classList.remove("hidden");

        itemsListEl.innerHTML = items.map(renderCartItem).join("");
        totalEl.textContent = formatPrice(total);

        if (checkoutButton) checkoutButton.disabled = false;

        setupQuantityControls();
      }
    } catch (error) {
      console.error("Error updating mini cart display:", error);
      loadingEl.classList.add("hidden");
      emptyEl.classList.remove("hidden");
    }
  }

  function setupQuantityControls(): void {
    const itemsListEl = document.getElementById("items-list");
    if (!itemsListEl) return;

    // Remove existing listeners to prevent conflicts
    const newItemsList = itemsListEl.cloneNode(true) as HTMLElement;
    const parent = itemsListEl.parentNode;
    if (parent) {
      parent.replaceChild(newItemsList, itemsListEl);
    }

    // Add event listener for both quantity controls AND product links
    newItemsList.addEventListener("click", async (e) => {
      // Handle product links
      const productLink = (e.target as HTMLElement).closest(
        "a.product-link"
      ) as HTMLAnchorElement;
      if (productLink) {
        // Don't prevent default - let link work naturally
        // Just close the mini cart and let Astro handle navigation
        closeMiniCart();
        return;
      }

      // Handle quantity control buttons (existing logic)
      const button = (e.target as HTMLElement).closest(
        "button[data-action]"
      ) as HTMLButtonElement;
      if (!button || button.disabled) return;

      e.preventDefault();

      const action = button.dataset.action;
      const itemKey = button.dataset.itemKey;
      const itemTitle = button.dataset.itemTitle;

      if (!itemKey) return;

      try {
        const cartInstance = await loadCart();

        switch (action) {
          case "increase":
            const items = cartInstance.getItems();
            const item = items.find(
              (i: CartItem) => `${i.id}:${i.variationId}` === itemKey
            );
            if (item) {
              const newQty = item.quantity + 1;
              const inventory = inventoryData[item.variationId] || 999;

              if (newQty <= inventory) {
                await cartInstance.updateQuantity(itemKey, newQty);
                await updateMiniCartDisplay();
              } else {
                showNotification(`Only ${inventory} available`, "error");
              }
            }
            break;

          case "decrease":
            const currentItems = cartInstance.getItems();
            const currentItem = currentItems.find(
              (i: CartItem) => `${i.id}:${i.variationId}` === itemKey
            );
            if (currentItem) {
              if (currentItem.quantity === 1) {
                // Use existing modal system if available, fallback to confirm
                if (
                  typeof window !== "undefined" &&
                  (window as any).showModal
                ) {
                  (window as any).showModal(
                    "Remove Item",
                    `Remove "${currentItem.title}" from your cart?`,
                    async () => {
                      cartInstance.removeItem(itemKey);
                      await updateMiniCartDisplay();
                      showNotification("Item removed from cart", "success");
                    },
                    "Remove",
                    "Cancel"
                  );
                } else if (
                  confirm(`Remove "${currentItem.title}" from your cart?`)
                ) {
                  cartInstance.removeItem(itemKey);
                  await updateMiniCartDisplay();
                  showNotification("Item removed from cart", "success");
                }
              } else {
                await cartInstance.updateQuantity(
                  itemKey,
                  currentItem.quantity - 1
                );
                await updateMiniCartDisplay();
              }
            }
            break;

          case "remove":
            if (itemTitle) {
              // Use existing modal system if available, fallback to confirm
              if (typeof window !== "undefined" && (window as any).showModal) {
                (window as any).showModal(
                  "Remove Item",
                  `Remove "${itemTitle}" from your cart?`,
                  async () => {
                    cartInstance.removeItem(itemKey);
                    await updateMiniCartDisplay();
                    showNotification("Item removed from cart", "success");
                  },
                  "Remove",
                  "Cancel"
                );
              } else if (confirm(`Remove "${itemTitle}" from your cart?`)) {
                cartInstance.removeItem(itemKey);
                await updateMiniCartDisplay();
                showNotification("Item removed from cart", "success");
              }
            }
            break;
        }
      } catch (error) {
        console.error("Error handling quantity action:", error);
        showNotification("Error updating cart", "error");
      }
    });

    // Make closeMiniCart function accessible to this scope
    function closeMiniCart() {
      const overlay = document.getElementById("mini-cart-overlay");
      const panel = document.getElementById("mini-cart-panel");

      if (overlay && panel) {
        // Use inert to immediately disable interaction (modern approach)
        panel.setAttribute("inert", "");

        overlay.classList.add("opacity-0");
        panel.classList.add("translate-x-full");

        // Restore page scrolling when MiniCart is closed
        document.body.style.overflow = "unset";

        setTimeout(() => {
          overlay.classList.add("hidden");
          // Clean up inert attribute after modal is fully closed
          panel.removeAttribute("inert");
        }, 300);
      }
    }
  }

  function initMiniCart() {
    const overlay = document.getElementById("mini-cart-overlay");
    const panel = document.getElementById("mini-cart-panel");
    const closeButton = document.getElementById("close-mini-cart");
    const continueShoppingButton = document.getElementById("continue-shopping");
    const checkoutButton = document.getElementById("mini-cart-checkout");
    const viewCartButton = document.getElementById("view-full-cart");

    // Early return if essential elements missing
    if (!overlay || !panel || !closeButton) {
      console.error("Mini cart elements not found");
      return;
    }

    function openMiniCart() {
      if (overlay && panel && closeButton) {
        overlay.classList.remove("hidden");

        // Prevent page scrolling when MiniCart is open
        document.body.style.overflow = "hidden";

        requestAnimationFrame(() => {
          overlay.classList.remove("opacity-0");
          panel.classList.remove("translate-x-full");
        });

        closeButton.focus();
        updateMiniCartDisplay();
      }
    }

    function closeMiniCart() {
      if (overlay && panel) {
        overlay.classList.add("opacity-0");
        panel.classList.add("translate-x-full");

        // Restore page scrolling when MiniCart is closed
        document.body.style.overflow = "unset";

        setTimeout(() => {
          overlay.classList.add("hidden");
        }, 300);
      }
    }

    closeButton.addEventListener("click", closeMiniCart);
    overlay.addEventListener("click", closeMiniCart);

    if (continueShoppingButton) {
      continueShoppingButton.addEventListener("click", closeMiniCart);
    }

    if (checkoutButton) {
      checkoutButton.addEventListener("click", handleCheckout);
    }

    if (viewCartButton) {
      viewCartButton.addEventListener("click", () => {
        window.location.href = "/cart";
      });
    }

    window.addEventListener("openMiniCart", openMiniCart);
    window.addEventListener("cartUpdated", updateMiniCartDisplay);

    document.addEventListener("keydown", (e) => {
      if (
        e.key === "Escape" &&
        panel &&
        !panel.classList.contains("translate-x-full")
      ) {
        closeMiniCart();
      }
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initMiniCart);
  } else {
    initMiniCart();
  }

  document.addEventListener("astro:page-load", initMiniCart);
</script>
