---
// src/components/wordpress/blocks/WPImage.astro
// Enhanced image component for wp-block-image with optimized loading

import { EnhancedImageOptimizer } from "@/lib/image/enhanced-optimizer";
import {
  EL_CAMINO_LOGO_DATA_URI,
  EL_CAMINO_LOADER_DATA_URI,
} from "@/lib/constants/assets";

interface Props {
  src: string;
  alt: string;
  caption?: string;
  alignment?: "default" | "wide" | "full";
  priority?: boolean;
  width?: number;
  height?: number;
  loading?: "eager" | "lazy";
}

const {
  src,
  alt,
  caption,
  alignment = "default",
  priority = false,
  width,
  height,
  loading,
} = Astro.props;

const alignmentClasses = {
  default: "max-w-4xl mx-auto",
  wide: "max-w-6xl mx-auto",
  full: "w-full",
};

// Optimize image based on alignment size
const sizeSettings = {
  full: { width: 1200, height: 800 },
  wide: { width: 800, height: 600 },
  default: { width: 600, height: 400 },
};

// Use provided dimensions or alignment defaults
const imgWidth =
  width || sizeSettings[alignment as keyof typeof sizeSettings].width;
const imgHeight =
  height || sizeSettings[alignment as keyof typeof sizeSettings].height;

// Smart loading strategy: priority images load eagerly, others lazy
const imageLoading = loading || (priority ? "eager" : "lazy");
const fetchPriority = priority ? "high" : "auto";

// Generate optimized sources using EnhancedImageOptimizer
// PHASE 4 TRACK B: Reduced quality to 75 for 20-30% faster load times
const imageSet = EnhancedImageOptimizer.generateOptimizedSources(src, {
  width: imgWidth,
  height: imgHeight,
  quality: 75, // Reduced from 85 for better compression
  priority: priority,
});

// Use best available format
const optimizedSrc = imageSet.avif || imageSet.webp || imageSet.jpeg;
const imageId = `wp-img-${Math.random().toString(36).substring(2, 11)}`;
const placeholderId = `${imageId}-placeholder`;
---

<figure class={`wp-image my-8 ${alignmentClasses[alignment]}`}>
  <div class="relative overflow-hidden bg-(--surface-secondary)">
    <!-- Loading placeholder -->
    <div
      class="loading-skeleton absolute inset-0"
      id={placeholderId}
      style={`aspect-ratio: ${imgWidth} / ${imgHeight}; animation: shimmer 1.5s ease-in-out infinite;`}
    >
      <!-- El Camino logo as loading indicator -->
      <div
        class="absolute inset-0 flex items-center justify-center opacity-70"
        style={`background-image: url('${EL_CAMINO_LOADER_DATA_URI}'); background-size: 48px 42px; background-position: center; background-repeat: no-repeat;`}
      >
      </div>
    </div>

    <!-- Optimized image -->
    <img
      id={imageId}
      src={optimizedSrc}
      alt={alt}
      width={imgWidth}
      height={imgHeight}
      loading={imageLoading}
      fetchpriority={fetchPriority}
      decoding="async"
      class="w-full h-auto object-cover opacity-0 transition-opacity duration-300"
      onload={`this.style.opacity='1'; document.getElementById('${placeholderId}')?.remove();`}
      onerror={`this.src='${EL_CAMINO_LOGO_DATA_URI}'; this.style.opacity='1'; document.getElementById('${placeholderId}')?.remove();`}
    />
  </div>

  {
    caption && (
      <figcaption class="mt-3 text-center text-(--content-meta) text-sm leading-relaxed">
        <span set:html={caption} />
      </figcaption>
    )
  }
</figure>
