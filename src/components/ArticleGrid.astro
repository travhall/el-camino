---
// src/components/ArticleGrid.astro - Enhanced with filterable grid/list support
import ArticleCard from "./ArticleCard.astro";
import ArticleCardSkeleton from "./ArticleCardSkeleton.astro";
import Sidebar from "./Sidebar.astro";
import type { WordPressPost } from "@/lib/wordpress/types";

interface Props {
  posts: WordPressPost[];
  error?: string | null;
  isLoading?: boolean;
  showSidebar?: boolean; // Legacy support for home page
  filterable?: boolean; // New: enables filterable news page layout
  view?: "grid" | "list"; // New: controls grid vs list view for filterable mode
}

const {
  posts,
  error = null,
  isLoading = !posts.length,
  showSidebar = false,
  filterable = false,
  view = "grid",
} = Astro.props;

// If sidebar is shown (home page), limit to 6 posts
const displayPosts = showSidebar ? posts.slice(0, 6) : posts;

// Loading skeleton count
const skeletonCount = showSidebar ? 6 : 12;

// Determine card variant based on layout mode
const getCardVariant = (_index: number) => {
  if (filterable) {
    return view; // "grid" or "list"
  }
  return "masonry"; // Home page masonry layout
};

// OPTIMIZATION: Conservative priority loading
// Home page: first image only (LCP critical)
// News grid: first 2 images (reduce eager loading for mobile)
// News list: first image only (large cards)
const shouldPrioritize = (index: number) => {
  if (!filterable) return index === 0; // Home page - first only
  return view === "grid" ? index < 2 : index === 0; // News - more conservative
};

// Get container classes based on layout mode
const getContainerClasses = () => {
  if (filterable) {
    if (view === "list") {
      return "flex flex-col gap-1";
    } else {
      // Grid view for news page - simpler than masonry
      return "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-1";
    }
  }
  // Original masonry layout for home page
  return "article-grid flex flex-col sm:grid sm:justify-center sm:grid-cols-6 2xl:grid-cols-8 sm:auto-rows-auto md:auto-rows-[12vw] lg:auto-rows-[10vw] xl:auto-rows-[9vw] 2xl:auto-rows-[9.5vw] w-full gap-1 p-1 pb-0";
};

// Get skeleton variant for loading states
const getSkeletonVariant = () => {
  if (filterable && view === "list") {
    return "list";
  } else if (filterable && view === "grid") {
    return "grid";
  }
  return "masonry";
};
---

{
  error && (
    <div class="text-state-error-text bg-state-error-surface p-4 rounded">
      {error}
    </div>
  )
}

<div
  class={getContainerClasses()}
  id={filterable ? "filterable-article-grid" : undefined}
  role={filterable ? "feed" : undefined}
  aria-label={filterable ? "Article listings" : undefined}
  aria-busy="false"
>
  {
    isLoading ? (
      Array(skeletonCount)
        .fill(null)
        .map((_, i) => (
          <ArticleCardSkeleton
            featured={!filterable && i === 0}
            variant={getSkeletonVariant()}
          />
        ))
    ) : displayPosts.length > 0 ? (
      <>
        {displayPosts.map((post, index) => {
          // Pass animation data attributes to all cards
          if (filterable) {
            return (
              <div
                class="article-card-wrapper opacity-0"
                data-initial-index={index}
                data-variant={getCardVariant(index)}
              >
                <ArticleCard
                  post={post}
                  featured={false}
                  priority={shouldPrioritize(index)}
                  variant={getCardVariant(index)}
                />
              </div>
            );
          } else {
            // Home page - pass animation props directly to ArticleCard
            return (
              <ArticleCard
                post={post}
                featured={index === 0}
                priority={shouldPrioritize(index)}
                variant={getCardVariant(index)}
                data-initial-index={index}
                data-variant={getCardVariant(index)}
              />
            );
          }
        })}

        {/* Home page sidebar and CTA (only for non-filterable mode) */}
        {showSidebar && !filterable && (
          <>
            <Sidebar />
            <div class="bg-(--surface-secondary) col-span-full md:col-span-4 2xl:col-span-6 2xl:row-span-2 p-4 -mt-1 md:mt-0 place-content-center">
              {/* <h3 class="font-display font-bold text-6xl inline-block">
                Get all the latest El Camino news here
              </h3> */}
            </div>
          </>
        )}
      </>
    ) : (
      <p class="text-(--content-body) text-center py-12 col-span-full">
        No posts found.
      </p>
    )
  }
</div>

<style is:global>
  /* Animation Configuration */
  :root {
    --card-transition-duration: 0.5s;
    --card-stagger-delay: 100ms;
    --row-stagger-delay: 150ms;
  }

  /* Responsive optimizations */
  @media (max-width: 1023px) {
    :root {
      --card-transition-duration: 0.2s; /* Faster on mobile */
      --card-stagger-delay: 50ms;
      --row-stagger-delay: 100ms;
    }
  }

  /* Respect reduced motion preferences */
  @media (prefers-reduced-motion: reduce) {
    :root {
      --card-transition-duration: 0.1s;
      --card-stagger-delay: 0ms;
      --row-stagger-delay: 0ms;
    }
  }

  /* Article Card Animation Wrapper - works for both masonry and grid/list */
  .article-card-wrapper {
    transform: translate3d(0, 0, 0); /* GPU acceleration */

    /* Bidirectional transitions for entry AND exit */
    transition:
      opacity var(--card-transition-duration) ease,
      transform var(--card-transition-duration) ease;

    /* Stagger delay only applies when entering (via --animation-order) */
    transition-delay:
      calc(var(--animation-order, 0) * var(--card-stagger-delay)),
      calc(var(--animation-order, 0) * var(--card-stagger-delay));
  }

  /* Exit state */
  .article-card-wrapper.opacity-0 {
    opacity: 0;
    transform: scale(0.95) translate3d(0, 10px, 0);
    /* Remove delay on exit for immediate response */
    transition-delay: 0s, 0s;
  }

  /* Entry state */
  .article-card-wrapper.opacity-100 {
    opacity: 1;
    transform: scale(1) translate3d(0, 0, 0);
    /* Delay is inherited from base rule for staggered entrance */
  }

  /* Temporary will-change during animation only */
  .article-card-wrapper.animating {
    will-change: opacity, transform;
  }

  .article-card-wrapper:not(.animating) {
    will-change: auto;
  }
</style>

<style>

  /* List view specific styles */
  .flex.flex-col.gap-1 .group:hover {
    transform: translateX(4px);
  }

  /* Grid view specific styles */
  .grid.gap-1 .group:hover {
    transform: translateY(-4px);
  }

  /* Masonry layout styles (preserved from original) */
  .article-grid .group:hover {
    z-index: 10;
  }

  /* Responsive adjustments for different views */
  @media (max-width: 768px) {
    .grid.gap-1 {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 1024px) {
    .grid.gap-1 {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>

<script>
  import { FilterCoordinator } from "@/lib/filterCoordinator";

  // Check for reduced motion preference
  const prefersReducedMotion = window.matchMedia(
    "(prefers-reduced-motion: reduce)"
  ).matches;

  // Parse animation timing from CSS custom properties
  function getAnimationTiming() {
    const style = getComputedStyle(document.documentElement);

    const durationStr = style
      .getPropertyValue("--card-transition-duration")
      .trim();
    let duration = 300;
    if (durationStr.includes("ms")) {
      duration = parseInt(durationStr.replace("ms", ""));
    } else if (durationStr.includes("s")) {
      duration = parseFloat(durationStr.replace("s", "")) * 1000;
    }

    const staggerStr = style.getPropertyValue("--card-stagger-delay").trim();
    const staggerDelay = parseInt(staggerStr.replace("ms", "")) || 0;

    const rowStaggerStr = style.getPropertyValue("--row-stagger-delay").trim();
    const rowStaggerDelay = parseInt(rowStaggerStr.replace("ms", "")) || 0;

    return { duration, staggerDelay, rowStaggerDelay };
  }

  const ANIMATION_CONFIG = getAnimationTiming();

  // Calculate cards per row based on viewport and view
  function getCardsPerRow(view: string) {
    if (view === "list") return 1; // List view is always single column

    const width = window.innerWidth;

    // Masonry layout (home page) - use grid column count
    if (view === "masonry") {
      if (width >= 1536) return 8; // 2xl:grid-cols-8
      if (width >= 640) return 6; // sm:grid-cols-6
      return 1; // mobile - single column
    }

    // Grid view (news page)
    if (width >= 1536) return 5; // 2xl:grid-cols-5
    if (width >= 1280) return 4; // xl:grid-cols-4
    if (width >= 1024) return 3; // lg:grid-cols-3
    if (width >= 768) return 2; // md:grid-cols-2
    return 1; // mobile
  }

  // Initialize entrance animations for article cards and sidebar
  function initializeArticleAnimations() {
    // Find all article cards and sidebar with animation wrapper class
    const cards = document.querySelectorAll(".article-card-wrapper.opacity-0");

    if (!cards.length) return;

    // Skip animations if reduced motion preferred
    if (prefersReducedMotion) {
      cards.forEach((card) => {
        const htmlCard = card as HTMLElement;
        htmlCard.classList.remove("opacity-0");
        htmlCard.classList.add("opacity-100");
      });
      return;
    }

    // Get current view from first card (excluding sidebar)
    const firstCard = Array.from(cards).find(
      (card) => !(card as HTMLElement).dataset.variant?.includes("sidebar")
    ) as HTMLElement;
    const view = firstCard?.dataset.variant || "grid";
    const cardsPerRow = getCardsPerRow(view);

    // For masonry (home page), animate all cards immediately without intersection observer
    // For grid/list (news page), use intersection observer to animate on scroll
    const isMasonryLayout = view === "masonry";

    if (isMasonryLayout) {
      // Animate all cards immediately
      cards.forEach((card) => {
        const htmlCard = card as HTMLElement;
        const index = parseInt(htmlCard.dataset.initialIndex || "0");
        const isSidebar = htmlCard.dataset.variant === "sidebar";

        // Calculate animation order
        let animationOrder: number;
        if (isSidebar) {
          animationOrder = 9;
        } else {
          const rowIndex = Math.floor(index / cardsPerRow);
          const cardInRow = index % cardsPerRow;
          animationOrder = rowIndex * 3 + cardInRow * 1.2;
        }

        // Set animation properties
        htmlCard.style.setProperty("--animation-order", animationOrder.toString());
        htmlCard.classList.add("animating");
        htmlCard.classList.remove("opacity-0");
        htmlCard.classList.add("opacity-100");

        // Remove will-change after animation
        const totalAnimationTime = ANIMATION_CONFIG.duration + animationOrder * ANIMATION_CONFIG.staggerDelay;
        setTimeout(() => {
          htmlCard.classList.remove("animating");
        }, totalAnimationTime);
      });

      return; // Skip intersection observer setup
    }

    // For grid/list views, use intersection observer
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const card = entry.target as HTMLElement;
            const index = parseInt(card.dataset.initialIndex || "0");
            const isSidebar = card.dataset.variant === "sidebar";

            // Calculate animation order
            let animationOrder: number;
            if (isSidebar) {
              // Sidebar animates after the article cards it appears near
              animationOrder = 9;
            } else if (view === "list") {
              // Sequential stagger for list view
              animationOrder = index * 1.5;
            } else {
              // Row-based stagger for grid/masonry view
              const rowIndex = Math.floor(index / cardsPerRow);
              const cardInRow = index % cardsPerRow;
              animationOrder = rowIndex * 3 + cardInRow * 1.2;
            }

            // Set CSS custom property for animation delay
            card.style.setProperty(
              "--animation-order",
              animationOrder.toString()
            );

            // Add animating class for temporary will-change
            card.classList.add("animating");

            // Trigger CSS animation
            card.classList.remove("opacity-0");
            card.classList.add("opacity-100");

            // Remove will-change after animation completes
            const duration = ANIMATION_CONFIG.duration;
            const totalAnimationTime =
              duration + animationOrder * ANIMATION_CONFIG.staggerDelay;

            setTimeout(() => {
              card.classList.remove("animating");
            }, totalAnimationTime);

            // Stop observing this card
            observer.unobserve(card);
          }
        });
      },
      {
        threshold: 0.1,
        rootMargin: "200px",
      }
    );

    // Observe all cards
    cards.forEach((card) => observer.observe(card));
  }

  // Initialize on page load
  document.addEventListener("astro:page-load", () => {
    // Check for both filterable and home page cards
    const filterableGrid = document.getElementById("filterable-article-grid");
    const homePageCards = document.querySelectorAll(".article-card-wrapper");

    if (filterableGrid) {
      // Make filterable grid visible
      filterableGrid.style.opacity = "1";
    }

    // Initialize animations for any cards found
    if (homePageCards.length > 0) {
      initializeArticleAnimations();
    }

    // SIMPLIFIED: Basic lazy loading without heavy intersection observer
    const lazyImages = document.querySelectorAll("img[data-src]");
    if (lazyImages.length > 0 && "IntersectionObserver" in window) {
      const imageObserver = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              const img = entry.target as HTMLImageElement;
              if (img.dataset.src) {
                img.src = img.dataset.src;
                img.removeAttribute("data-src");
                imageObserver.unobserve(img);
              }
            }
          });
        },
        { rootMargin: "100px" }
      );

      if (lazyImages.length > 6) {
        lazyImages.forEach((img) => imageObserver.observe(img));
      } else {
        lazyImages.forEach((img: Element) => {
          const imgEl = img as HTMLImageElement;
          if (imgEl.dataset.src) {
            imgEl.src = imgEl.dataset.src;
            imgEl.removeAttribute("data-src");
          }
        });
      }
    }
  });

  // Listen for articleGridReady event from FilterCoordinator
  window.addEventListener("articleGridReady", () => {
    initializeArticleAnimations();
  });
</script>
