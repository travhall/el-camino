---
// src/components/Header.astro
import Nav from "@/components/Nav.astro";
import { Icon } from "astro-icon/components";
import CartButton from "./CartButton.astro";
import CartButtonMobile from "./CartButtonMobile.astro";
import { detectDeviceFromUA } from "@/utils/device";

interface Props {
  activeCategory?: string;
}

const { activeCategory } = Astro.props;

// Device detection for conditional rendering
const userAgent = Astro.request.headers.get("user-agent") || "";
const deviceInfo = detectDeviceFromUA(userAgent);
const isMobile = deviceInfo.isMobile;
---

<style>
  /* One-time header fade-in animation */
  #site-header {
    opacity: 0; /* Hidden by default until script runs */
  }

  #site-header.header-visible {
    opacity: 1; /* Visible without animation (subsequent page loads) */
  }

  #site-header.header-initial-load {
    opacity: 0;
    animation: fadeInHeader 0.6s ease-out 0.2s forwards;
  }

  @keyframes fadeInHeader {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Respect reduced motion preferences */
  @media (prefers-reduced-motion: reduce) {
    #site-header.header-initial-load {
      animation: none;
      opacity: 1;
      transform: none;
    }
  }
</style>

<header
  id="site-header"
  class="flex flex-row items-center justify-between -mb-1 sticky top-0 z-50 border-4 border-(--border-secondary) bg-(--surface-secondary)"
>
  <a
    href="/"
    class="flex self-center justify-start hover:opacity-60 focus-within:opacity-60 transition-opacity"
    aria-label="Home Link"
  >
    <Icon
      name="Logo"
      class="w-48 xl:w-56 h-auto p-1 m-4 text-(--content-heading)"
      title="Go Home to El Camino"
    />
  </a>

  <Nav activeCategory={activeCategory} />

  <div
    class="utility-menu self-center justify-end lg:order-last flex mr-1 gap-2"
    transition:persist="utility-menu"
  >
    {isMobile ? <CartButtonMobile /> : <CartButton />}
    <button
      id="mobile-menu-toggle"
      class="p-2 lg:hidden text-(--content-body)"
      aria-label="Toggle mobile menu"
      aria-expanded="false"
    >
      <Icon name="uil:bars" class="w-6 h-6" id="menu-icon" />
      <Icon name="uil:times" class="w-6 h-6 hidden" id="close-icon" />
    </button>
  </div>
</header>

<script>
  // One-time header fade-in animation on initial page load
  function initializeHeaderAnimation() {
    const STORAGE_KEY = "header-animated";
    const header = document.getElementById("site-header");

    if (!header) return;

    // Check if this is the first page load of the session
    const hasAnimated = sessionStorage.getItem(STORAGE_KEY);

    if (!hasAnimated) {
      // First load - apply animation class
      header.classList.add("header-initial-load");
      // Store flag so it doesn't animate again this session
      sessionStorage.setItem(STORAGE_KEY, "true");
    } else {
      // Already animated this session - show immediately without animation
      header.classList.add("header-visible");
    }
  }

  // Run on initial page load
  initializeHeaderAnimation();

  // Handle view transitions - restore header visibility on page swap
  document.addEventListener("astro:after-swap", () => {
    const header = document.getElementById("site-header");
    if (header) {
      // Always show header immediately on subsequent navigations
      header.classList.remove("header-initial-load");
      header.classList.add("header-visible");
    }
  });

  // Handle menu toggle functionality
  function setupMobileMenu() {
    const toggleButton = document.getElementById(
      "mobile-menu-toggle"
    ) as HTMLButtonElement;
    const menuIcon = document.getElementById("menu-icon") as HTMLElement;
    const closeIcon = document.getElementById("close-icon") as HTMLElement;
    const nav = document.querySelector("nav") as HTMLElement;

    // Early return if elements don't exist
    if (!toggleButton || !menuIcon || !closeIcon || !nav) return;

    function handleToggle(e: MouseEvent) {
      e.stopPropagation();
      const isExpanded = toggleButton.getAttribute("aria-expanded") === "true";

      toggleButton.setAttribute("aria-expanded", (!isExpanded).toString());
      menuIcon.classList.toggle("hidden");
      closeIcon.classList.toggle("hidden");
      nav.classList.toggle("nav-open");
      document.body.style.overflow = isExpanded ? "unset" : "hidden";
    }

    // Remove existing event listener if any
    toggleButton.removeEventListener("click", handleToggle);
    // Add new event listener
    toggleButton.addEventListener("click", handleToggle);

    // Close menu when clicking outside
    document.addEventListener("click", (e: MouseEvent) => {
      const isExpanded = toggleButton.getAttribute("aria-expanded") === "true";
      const clickTarget = e.target as Node;
      if (
        isExpanded &&
        !nav.contains(clickTarget) &&
        !toggleButton.contains(clickTarget)
      ) {
        toggleButton.click();
      }
    });

    // Close menu on escape key
    document.addEventListener("keydown", (e: KeyboardEvent) => {
      if (
        e.key === "Escape" &&
        toggleButton.getAttribute("aria-expanded") === "true"
      ) {
        toggleButton.click();
      }
    });
  }

  // Initialize menu
  setupMobileMenu();

  // Handle view transitions and page loads
  document.addEventListener("astro:after-swap", setupMobileMenu);
</script>
