---
// src/components/CartButton.astro
// Updated to trigger mini cart instead of navigation
import { Icon } from "astro-icon/components";
import { cart } from "@/lib/cart";
const cartCount = cart.getItemCount();
---

<button
  type="button"
  class="relative p-2"
  aria-label="Shopping Cart"
  id="cart-button"
>
  <Icon class="h-6 w-6 m-1" name="uil:shopping-cart" />
  <span
    id="cart-count"
    class:list={[
      "absolute top-1 right-0 bg-(--ui-button-surface) text-(--ui-button-text) text-xs rounded-full w-4 h-4 flex items-center justify-center",
      { hidden: cartCount === 0 },
    ]}
  >
    {cartCount}
  </span>
</button>

<script>
  let cartLoaded = false;
  let updateTimeout: number | null = null;
  // Initialize with server-rendered count to prevent initial flash
  let lastKnownCount: number | null = (() => {
    const countElement = document.getElementById("cart-count");
    return countElement ? parseInt(countElement.textContent || "0", 10) : null;
  })();

  async function loadCart() {
    if (!cartLoaded) {
      const { cart } = await import("@/lib/cart");
      cartLoaded = true;
      return cart;
    }
    return (await import("@/lib/cart")).cart;
  }

  async function updateCartCount(force = false) {
    if (updateTimeout) window.clearTimeout(updateTimeout);

    updateTimeout = window.setTimeout(async () => {
      const countElement = document.getElementById("cart-count");
      if (!countElement) return;

      try {
        const cart = await loadCart();
        const count = cart.getItemCount();

        // Only update DOM if count actually changed (prevents flash)
        if (force || lastKnownCount !== count) {
          countElement.textContent = count.toString();
          countElement.classList.toggle("hidden", count === 0);
          lastKnownCount = count;
        }
      } catch (error) {
        console.error("Error updating cart count:", error);
      }
    }, 50);
  }

  function initCartButton() {
    const cartButton = document.getElementById("cart-button");
    if (!cartButton) return;

    // CHANGE: Dispatch event instead of navigate
    cartButton.addEventListener("click", (e) => {
      e.preventDefault();
      // console.log("Cart button clicked, opening mini cart");
      window.dispatchEvent(new CustomEvent("openMiniCart"));
    });
  }

  // Initialize cart button
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initCartButton);
  } else {
    initCartButton();
  }

  // Re-initialize on Astro navigation
  document.addEventListener("astro:page-load", initCartButton);

  // Update cart count when cart is actually modified
  window.addEventListener("cartUpdated", () => updateCartCount(true));

  // On page load, only update if different (prevents flash during filtering)
  document.addEventListener("astro:page-load", () => updateCartCount(false));
</script>
