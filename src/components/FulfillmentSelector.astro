---
// src/components/FulfillmentSelector.astro
import {
  SHIPPING_RATES,
  PICKUP_LOCATION,
  calculateShippingRate,
} from "@/lib/config/shipping";

interface Props {
  subtotal: number;
}

const { subtotal } = Astro.props;

// Calculate which shipping rate applies
const applicableRate = calculateShippingRate(subtotal);
const freeShippingThreshold =
  SHIPPING_RATES.find((r) => r.id === "free")?.freeThreshold || 75;
---

<div
  class="fulfillment-selector p-4"
  data-component="fulfillment-selector"
  role="radiogroup"
  aria-required="true"
  aria-label="Shipping method selection"
>
  <h2 class="font-display text-3xl my-4 text-(--content-heading)">
    Choose Shipping Method <span class="text-red-600">*</span>
  </h2>
  <p class="text-sm text-(--content-meta) mb-3">
    Please select how you'd like to receive your order
  </p>

  <div class="fulfillment-options flex flex-col lg:flex-row gap-2">
    <!-- Shipping Option -->
    <label class="fulfillment-option block lg:basis-1/2">
      <input
        type="radio"
        name="fulfillment"
        value="shipping"
        data-method="shipping"
        class="sr-only peer"
      />
      <div
        class="border-2 border-(--border-primary) p-4 transition-all hover:border-(--content-emphasis)/50 cursor-pointer"
        data-option-card="shipping"
        data-selected="false"
        data-expanded="false"
      >
        <div class="flex items-start justify-between">
          <div class="flex items-start gap-3">
            <span class="text-2xl">üì¶</span>
            <div>
              <h3 class="font-display text-xl text-(--content-heading)">
                Ship to Me
              </h3>
              <p class="text-sm text-(--content-meta)">
                {applicableRate.description}
              </p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-right">
              {
                applicableRate.rate === 0 ? (
                  <span class="inline-block px-2 py-1 bg-green-600 text-white text-sm font-semibold">
                    FREE
                  </span>
                ) : (
                  <span class="font-display text-xl text-(--content-emphasis)">
                    ${applicableRate.rate.toFixed(2)}
                  </span>
                )
              }
            </div>
            <!-- Chevron indicator -->
            <svg
              class="w-6 h-6 text-(--content-body) transition-transform duration-300"
              data-chevron="shipping"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>
        </div>

        <!-- Shipping Address Form - Initially Hidden -->
        <div
          class="shipping-address-form space-y-3 pt-3 mt-3 border-t border-(--border-secondary) hidden"
          data-shipping-form
        >
          <h4 class="font-semibold text-(--content-body)">Shipping Address</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="md:col-span-2">
              <label
                for="ship-name"
                class="block text-sm text-(--content-body) mb-1"
                >Full Name *</label
              >
              <input
                type="text"
                id="ship-name"
                name="name"
                required
                autocomplete="name"
                class="w-full px-3 py-2 border border-(--border-primary) bg-(--surface-primary) text-(--content-body) focus:outline-none focus:ring-2 focus:ring-(--content-emphasis)"
              />
            </div>

            <div class="md:col-span-2">
              <label
                for="ship-email"
                class="block text-sm text-(--content-body) mb-1">Email *</label
              >
              <input
                type="email"
                id="ship-email"
                name="email"
                required
                autocomplete="email"
                class="w-full px-3 py-2 border border-(--border-primary) bg-(--surface-primary) text-(--content-body) focus:outline-none focus:ring-2 focus:ring-(--content-emphasis)"
              />
            </div>

            <div class="md:col-span-2">
              <label
                for="ship-phone"
                class="block text-sm text-(--content-body) mb-1">Phone *</label
              >
              <input
                type="tel"
                id="ship-phone"
                name="phone"
                required
                autocomplete="tel"
                class="w-full px-3 py-2 border border-(--border-primary) bg-(--surface-primary) text-(--content-body) focus:outline-none focus:ring-2 focus:ring-(--content-emphasis)"
              />
            </div>

            <div class="md:col-span-2">
              <label
                for="ship-street1"
                class="block text-sm text-(--content-body) mb-1"
                >Street Address *</label
              >
              <input
                type="text"
                id="ship-street1"
                name="street1"
                required
                autocomplete="address-line1"
                class="w-full px-3 py-2 border border-(--border-primary) bg-(--surface-primary) text-(--content-body) focus:outline-none focus:ring-2 focus:ring-(--content-emphasis)"
              />
            </div>

            <div class="md:col-span-2">
              <label
                for="ship-street2"
                class="block text-sm text-(--content-body) mb-1"
                >Apt/Suite (Optional)</label
              >
              <input
                type="text"
                id="ship-street2"
                name="street2"
                autocomplete="address-line2"
                class="w-full px-3 py-2 border border-(--border-primary) bg-(--surface-primary) text-(--content-body) focus:outline-none focus:ring-2 focus:ring-(--content-emphasis)"
              />
            </div>

            <div>
              <label
                for="ship-city"
                class="block text-sm text-(--content-body) mb-1">City *</label
              >
              <input
                type="text"
                id="ship-city"
                name="city"
                required
                autocomplete="address-level2"
                class="w-full px-3 py-2 border border-(--border-primary) bg-(--surface-primary) text-(--content-body) focus:outline-none focus:ring-2 focus:ring-(--content-emphasis)"
              />
            </div>

            <div>
              <label
                for="ship-state"
                class="block text-sm text-(--content-body) mb-1">State *</label
              >
              <select
                id="ship-state"
                name="state"
                required
                autocomplete="address-level1"
                class="w-full px-3 py-2 border border-(--border-primary) bg-(--surface-primary) text-(--content-body) focus:outline-none focus:ring-2 focus:ring-(--content-emphasis)"
              >
                <option value="">Select State...</option>
                <option value="AL">Alabama</option>
                <option value="AZ">Arizona</option>
                <option value="AR">Arkansas</option>
                <option value="CA">California</option>
                <option value="CO">Colorado</option>
                <option value="CT">Connecticut</option>
                <option value="DE">Delaware</option>
                <option value="FL">Florida</option>
                <option value="GA">Georgia</option>
                <option value="ID">Idaho</option>
                <option value="IL">Illinois</option>
                <option value="IN">Indiana</option>
                <option value="IA">Iowa</option>
                <option value="KS">Kansas</option>
                <option value="KY">Kentucky</option>
                <option value="LA">Louisiana</option>
                <option value="ME">Maine</option>
                <option value="MD">Maryland</option>
                <option value="MA">Massachusetts</option>
                <option value="MI">Michigan</option>
                <option value="MN">Minnesota</option>
                <option value="MS">Mississippi</option>
                <option value="MO">Missouri</option>
                <option value="MT">Montana</option>
                <option value="NE">Nebraska</option>
                <option value="NV">Nevada</option>
                <option value="NH">New Hampshire</option>
                <option value="NJ">New Jersey</option>
                <option value="NM">New Mexico</option>
                <option value="NY">New York</option>
                <option value="NC">North Carolina</option>
                <option value="ND">North Dakota</option>
                <option value="OH">Ohio</option>
                <option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option>
                <option value="PA">Pennsylvania</option>
                <option value="RI">Rhode Island</option>
                <option value="SC">South Carolina</option>
                <option value="SD">South Dakota</option>
                <option value="TN">Tennessee</option>
                <option value="TX">Texas</option>
                <option value="UT">Utah</option>
                <option value="VT">Vermont</option>
                <option value="VA">Virginia</option>
                <option value="WA">Washington</option>
                <option value="WV">West Virginia</option>
                <option value="WI" selected>Wisconsin</option>
                <option value="WY">Wyoming</option>
              </select>
            </div>

            <div>
              <label
                for="ship-zip"
                class="block text-sm text-(--content-body) mb-1"
                >ZIP Code *</label
              >
              <input
                type="text"
                id="ship-zip"
                name="zip"
                required
                pattern="[0-9]{5}"
                maxlength="5"
                autocomplete="postal-code"
                class="w-full px-3 py-2 border border-(--border-primary) bg-(--surface-primary) text-(--content-body) focus:outline-none focus:ring-2 focus:ring-(--content-emphasis)"
              />
            </div>
          </div>

          <!-- Dynamic Free Shipping Tracker -->
          <div
            id="free-shipping-tracker"
            class="hidden mt-3 p-3 bg-blue-50 border-l-4 border-blue-500"
          >
            <div class="flex items-center gap-2 text-sm text-blue-800">
              <span>üí°</span>
              <span id="free-shipping-message">
                <!-- JavaScript will populate this -->
              </span>
            </div>
          </div>
        </div>
      </div>
    </label>

    <!-- Pickup Option -->
    <label class="fulfillment-option block lg:basis-1/2">
      <input
        type="radio"
        name="fulfillment"
        value="pickup"
        data-method="pickup"
        class="sr-only peer"
      />
      <div
        class="border-2 border-(--border-primary) p-4 transition-all hover:border-(--content-emphasis)/50 cursor-pointer"
        data-option-card="pickup"
        data-selected="false"
        data-expanded="false"
      >
        <div class="flex items-start justify-between">
          <div class="flex items-start gap-3">
            <span class="text-2xl">üè™</span>
            <div>
              <h3 class="font-display text-xl text-(--content-heading)">
                Store Pickup
              </h3>
              <p class="text-sm text-(--content-meta)">Ready in 2-4 hours</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <span
              class="inline-block px-2 py-1 bg-green-600 text-white text-sm font-semibold"
              >FREE</span
            >
            <!-- Chevron indicator -->
            <svg
              class="w-6 h-6 text-(--content-body) transition-transform duration-300"
              data-chevron="pickup"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>
        </div>

        <!-- Pickup Contact Form - Initially Hidden -->
        <div
          class="pickup-contact-form space-y-3 pt-3 mt-3 border-t border-(--border-secondary) hidden"
          data-pickup-form
        >
          <h4 class="font-semibold text-(--content-body)">
            Contact Information
          </h4>
          <div class="grid grid-cols-1 gap-3">
            <div>
              <label
                for="pickup-name"
                class="block text-sm text-(--content-body) mb-1"
                >Full Name *</label
              >
              <input
                type="text"
                id="pickup-name"
                name="name"
                autocomplete="name"
                class="w-full px-3 py-2 border border-(--border-primary) bg-(--surface-primary) text-(--content-body) focus:outline-none focus:ring-2 focus:ring-(--content-emphasis)"
              />
            </div>

            <div>
              <label
                for="pickup-email"
                class="block text-sm text-(--content-body) mb-1">Email *</label
              >
              <input
                type="email"
                id="pickup-email"
                name="email"
                autocomplete="email"
                class="w-full px-3 py-2 border border-(--border-primary) bg-(--surface-primary) text-(--content-body) focus:outline-none focus:ring-2 focus:ring-(--content-emphasis)"
              />
            </div>

            <div>
              <label
                for="pickup-phone"
                class="block text-sm text-(--content-body) mb-1">Phone *</label
              >
              <input
                type="tel"
                id="pickup-phone"
                name="phone"
                autocomplete="tel"
                class="w-full px-3 py-2 border border-(--border-primary) bg-(--surface-primary) text-(--content-body) focus:outline-none focus:ring-2 focus:ring-(--content-emphasis)"
              />
            </div>

            <div>
              <label
                for="pickup-instructions"
                class="block text-sm text-(--content-body) mb-1"
              >
                Delivery Instructions (Optional)
              </label>
              <textarea
                id="pickup-instructions"
                name="instructions"
                rows="3"
                placeholder="e.g., Call when arriving, preferred pickup time, special requests..."
                class="w-full px-3 py-2 border border-(--border-primary) bg-(--surface-primary) text-(--content-body) focus:outline-none focus:ring-2 focus:ring-(--content-emphasis) resize-none"
              ></textarea>
            </div>
          </div>

          <div class="mt-3 p-3">
            <h5 class="font-semibold text-sm text-(--content-heading) mb-2">
              Pickup Location
            </h5>
            <address class="not-italic text-sm text-(--content-body) space-y-1">
              <div class="font-semibold">{PICKUP_LOCATION.name}</div>
              <div>{PICKUP_LOCATION.address.street1}</div>
              <div>
                {PICKUP_LOCATION.address.city}, {PICKUP_LOCATION.address.state}
                {PICKUP_LOCATION.address.zip}
              </div>
              <div>
                <a href={`tel:${PICKUP_LOCATION.phone}`} class="underline"
                  >{PICKUP_LOCATION.phone}</a
                >
              </div>
            </address>
            {
              PICKUP_LOCATION.instructions && (
                <p class="mt-2 text-sm text-(--content-meta) italic">
                  {PICKUP_LOCATION.instructions}
                </p>
              )
            }
          </div>
        </div>
      </div>
    </label>
  </div>
</div>

<script>
  const FREE_SHIPPING_THRESHOLD = 75.0;

  function initFulfillmentSelector() {
    const selector = document.querySelector(
      '[data-component="fulfillment-selector"]'
    );
    if (!selector) return;

    const radios = selector.querySelectorAll('input[name="fulfillment"]');
    const shippingCard = selector.querySelector(
      '[data-option-card="shipping"]'
    );
    const pickupCard = selector.querySelector('[data-option-card="pickup"]');
    const shippingForm = selector.querySelector("[data-shipping-form]");
    const pickupForm = selector.querySelector("[data-pickup-form]");
    const shippingChevron = selector.querySelector('[data-chevron="shipping"]');
    const pickupChevron = selector.querySelector('[data-chevron="pickup"]');

    // Initially hide both forms and remove required from all fields
    shippingForm?.classList.add("hidden");
    pickupForm?.classList.add("hidden");

    shippingForm?.querySelectorAll("input, select").forEach((el) => {
      (el as HTMLInputElement | HTMLSelectElement).required = false;
    });
    pickupForm?.querySelectorAll("input").forEach((el) => {
      (el as HTMLInputElement).required = false;
    });

    // Handle card click - combines selection and toggle
    function handleCardClick(method: "shipping" | "pickup") {
      const clickedCard = method === "shipping" ? shippingCard : pickupCard;
      const otherCard = method === "shipping" ? pickupCard : shippingCard;
      const clickedForm = method === "shipping" ? shippingForm : pickupForm;
      const otherForm = method === "shipping" ? pickupForm : shippingForm;
      const clickedChevron =
        method === "shipping" ? shippingChevron : pickupChevron;
      const otherChevron =
        method === "shipping" ? pickupChevron : shippingChevron;
      const clickedRadio = Array.from(radios).find(
        (r) => (r as HTMLInputElement).value === method
      ) as HTMLInputElement;

      const isCurrentlySelected =
        clickedCard?.getAttribute("data-selected") === "true";
      const isCurrentlyExpanded =
        clickedCard?.getAttribute("data-expanded") === "true";

      if (!isCurrentlySelected) {
        // First-time selection: select + expand

        // Check the radio and trigger change event
        if (clickedRadio) {
          clickedRadio.checked = true;
          clickedRadio.dispatchEvent(new Event("change", { bubbles: true }));
        }

        // Update selection states
        clickedCard?.setAttribute("data-selected", "true");
        clickedCard?.classList.add(
          "bg-(--surface-secondary)",
          "border-(--content-emphasis)"
        );
        otherCard?.setAttribute("data-selected", "false");
        otherCard?.classList.remove(
          "bg-(--surface-secondary)",
          "border-(--content-emphasis)"
        );

        // Expand clicked, collapse other
        clickedCard?.setAttribute("data-expanded", "true");
        clickedForm?.classList.remove("hidden");
        clickedChevron?.classList.add("rotate-180");

        otherCard?.setAttribute("data-expanded", "false");
        otherForm?.classList.add("hidden");
        otherChevron?.classList.remove("rotate-180");

        // Set required fields
        if (method === "shipping") {
          shippingForm
            ?.querySelectorAll("input[required], select[required]")
            .forEach((el) => {
              (el as HTMLInputElement | HTMLSelectElement).required = true;
            });
          pickupForm?.querySelectorAll("input").forEach((el) => {
            (el as HTMLInputElement).required = false;
          });
        } else {
          pickupForm?.querySelectorAll("input").forEach((el) => {
            (el as HTMLInputElement).required = true;
          });
          shippingForm?.querySelectorAll("input, select").forEach((el) => {
            (el as HTMLInputElement | HTMLSelectElement).required = false;
          });
        }

        // Trigger order summary update
        if (
          typeof window !== "undefined" &&
          (window as any).updateOrderSummaryOnFulfillmentChange
        ) {
          (window as any).updateOrderSummaryOnFulfillmentChange();
        }
      } else {
        // Already selected: just toggle expand/collapse
        if (isCurrentlyExpanded) {
          // Collapse
          clickedCard?.setAttribute("data-expanded", "false");
          clickedForm?.classList.add("hidden");
          clickedChevron?.classList.remove("rotate-180");
        } else {
          // Expand
          clickedCard?.setAttribute("data-expanded", "true");
          clickedForm?.classList.remove("hidden");
          clickedChevron?.classList.add("rotate-180");
        }
      }
    }

    // Attach click handlers to cards
    shippingCard?.addEventListener("click", () => handleCardClick("shipping"));
    pickupCard?.addEventListener("click", () => handleCardClick("pickup"));

    // Prevent form clicks from bubbling to card
    shippingForm?.addEventListener("click", (e) => e.stopPropagation());
    pickupForm?.addEventListener("click", (e) => e.stopPropagation());

    // Prevent radio clicks from bubbling (they're hidden anyway, but safety)
    radios.forEach((radio) => {
      radio.addEventListener("click", (e) => e.stopPropagation());
    });
  }

  function updateFreeShippingTracker(subtotal: number): void {
    const tracker = document.getElementById("free-shipping-tracker");
    const message = document.getElementById("free-shipping-message");

    if (!tracker || !message) return;

    // Get selected fulfillment method
    const shippingRadio = document.querySelector(
      'input[value="shipping"]:checked'
    );

    // Only show for shipping, not pickup or when nothing is selected
    if (!shippingRadio) {
      tracker.classList.add("hidden");
      return;
    }

    if (subtotal >= FREE_SHIPPING_THRESHOLD) {
      tracker.classList.add("hidden");
    } else {
      const amountNeeded = FREE_SHIPPING_THRESHOLD - subtotal;
      message.innerHTML = `Add <strong>$${amountNeeded.toFixed(2)}</strong> more for free shipping!`;
      tracker.classList.remove("hidden");
    }
  }

  // Make function globally available for cart.astro
  (window as any).updateFreeShippingTracker = updateFreeShippingTracker;

  document.addEventListener("astro:page-load", initFulfillmentSelector);
</script>
