---
// src/components/ProductFilters.astro - Fixed implementation
import type { FilterOptions } from "@/lib/square/types";

interface Props {
  filterOptions: FilterOptions;
  totalProducts: number;
  filteredCount: number;
}

const { filterOptions, totalProducts, filteredCount } = Astro.props;

// Parse current filters from URL for server-side rendering
const currentParams = new URLSearchParams(Astro.url.search);
const currentBrands = currentParams.getAll("brands") || [];
const currentPageSize = currentParams.get("pageSize") || "24";

// Configuration for show more/less functionality
const DEFAULT_VISIBLE_BRANDS = 6;
const shouldShowToggle = filterOptions.brands.length > DEFAULT_VISIBLE_BRANDS;
---

<!-- Desktop Filter Sidebar -->
<div class="lg:block sticky top-16">
  <form
    method="GET"
    action=""
    class="hidden lg:block p-2 overflow-y-auto"
    id="desktop-filter-form"
  >
    <input type="hidden" name="pageSize" value={currentPageSize} />

    <div class="flex items-center justify-between mb-2">
      <h2 class="text-sm font-semibold text-content-heading">Filters</h2>
      {
        currentBrands.length > 0 && (
          <a
            href={`${Astro.url.pathname}?pageSize=${currentPageSize}`}
            class="text-sm text-content-meta hover:text-content-emphasis transition-colors"
          >
            Clear Filters
          </a>
        )
      }
    </div>

    <!-- Results Count -->
    <div class="mb-2 p-2 bg-surface-secondary rounded-sm">
      <p class="text-sm text-content-meta">
        Showing <span>{filteredCount}</span> of <span>{totalProducts}</span> products
      </p>
    </div>

    <!-- Brand Filter Section -->
    {
      filterOptions.brands.length > 0 && (
        <div class="mb-4">
          <h3 class="text-sm font-medium text-content-heading mb-2">Brand</h3>
          <div class="space-y-1" id="desktop-brand-list">
            {filterOptions.brands.map((brand, index) => {
              const isInitiallyHidden = index >= DEFAULT_VISIBLE_BRANDS;
              return (
                <label
                  class={`flex items-center group cursor-pointer p-1 rounded-sm hover:bg-surface-secondary transition-colors ${isInitiallyHidden ? "hidden brand-extra-option" : ""}`}
                >
                  <input
                    type="checkbox"
                    name="brands"
                    value={brand.name}
                    checked={currentBrands.includes(brand.name)}
                    class="elco-checkbox mr-2 w-4 h-4 rounded-sm border-2 border-ui-input-border text-ui-accent focus:ring-2 focus:ring-ui-accent focus:ring-offset-0"
                  />
                  <span class="flex-1 text-content-body group-hover:text-content-emphasis">
                    {brand.name}
                  </span>
                  <span class="text-sm text-content-meta mr-2">
                    ({brand.count})
                  </span>
                </label>
              );
            })}

            {shouldShowToggle && (
              <button
                type="button"
                id="desktop-show-more-brands"
                class="w-full text-left text-sm text-ui-accent hover:text-ui-accent-hover transition-colors p-1 font-medium"
                data-hidden-count={
                  filterOptions.brands.length - DEFAULT_VISIBLE_BRANDS
                }
              >
                + Show {filterOptions.brands.length - DEFAULT_VISIBLE_BRANDS}{" "}
                more
              </button>
            )}
          </div>
        </div>
      )
    }
  </form>
</div>

<!-- Mobile Filter Button -->
<button
  id="mobile-filter-toggle"
  class="lg:hidden fixed bottom-4 right-4 bg-ui-nav-surface text-ui-button-primary-text rounded-md flex flex-row gap-2 p-4 shadow-lg z-[250] transition-transform"
  aria-label="Open Filters"
>
  Filters
  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path
      stroke-linecap="round"
      stroke-linejoin="round"
      stroke-width="2"
      d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.707A1 1 0 013 7V4z"
    ></path>
  </svg>
  {
    currentBrands.length > 0 && (
      <span class="absolute -top-1 -right-1 bg-ui-button-surface text-ui-button-text font-bold text-sm rounded-full min-w-[1.25rem] h-5 flex items-center justify-center px-1">
        {currentBrands.length}
      </span>
    )
  }
</button>

<!-- Mobile Drawer Overlay -->
<div
  id="mobile-filter-overlay"
  class="lg:hidden fixed inset-0 bg-surface-tertiary/80 dark:bg-surface-primary/80 backdrop-blur-sm z-40 transition-opacity duration-300 opacity-0 pointer-events-none"
>
</div>

<!-- Mobile Filter Drawer -->
<div
  id="mobile-filter-drawer"
  class="lg:hidden fixed bottom-0 left-0 right-0 bg-surface-secondary border-t border-ui-border z-[500] max-h-[80vh] overflow-y-auto transform translate-y-full transition-transform duration-300"
>
  <form method="GET" action="" class="p-4" id="mobile-filter-form">
    <input type="hidden" name="pageSize" value={currentPageSize} />

    <!-- Mobile Header -->
    <div
      class="flex items-center justify-between mb-4 pb-4 border-b border-ui-border"
    >
      <h2 class="text-lg font-semibold text-content-heading">
        Filter Products
      </h2>
      <button
        type="button"
        id="mobile-filter-close"
        class="p-1 text-content-meta hover:text-content-emphasis"
        aria-label="Close Filters"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Results Count -->
    <div class="mb-4 p-3 bg-surface-tertiary rounded-sm">
      <p class="text-sm text-content-meta">
        {filteredCount} of {totalProducts} products
      </p>
    </div>

    <!-- Mobile Brand Filter Section -->
    <div class="mb-6">
      <h3 class="text-base font-medium text-content-heading mb-3">Brand</h3>
      <div class="space-y-3" id="mobile-brand-list">
        {
          filterOptions.brands.map((brand, index) => {
            const isInitiallyHidden = index >= DEFAULT_VISIBLE_BRANDS;
            return (
              <label
                class={`flex items-center justify-between group cursor-pointer p-3 rounded-sm hover:bg-surface-tertiary transition-colors ${isInitiallyHidden ? "hidden mobile-brand-extra-option" : ""}`}
              >
                <div class="flex items-center">
                  <input
                    type="checkbox"
                    name="brands"
                    value={brand.name}
                    checked={currentBrands.includes(brand.name)}
                    class="elco-checkbox mr-3 w-5 h-5 rounded-sm border-2 border-ui-input-border text-ui-accent focus:ring-2 focus:ring-ui-accent focus:ring-offset-0"
                  />
                  <span class="text-content-body group-hover:text-content-emphasis">
                    {brand.name}
                  </span>
                </div>
                <span class="text-sm text-content-meta">({brand.count})</span>
              </label>
            );
          })
        }

        {
          shouldShowToggle && (
            <button
              type="button"
              id="mobile-show-more-brands"
              class="w-full text-left text-sm text-ui-accent hover:text-ui-accent-hover transition-colors p-3 font-medium"
              data-hidden-count={
                filterOptions.brands.length - DEFAULT_VISIBLE_BRANDS
              }
            >
              + Show {filterOptions.brands.length - DEFAULT_VISIBLE_BRANDS} more
            </button>
          )
        }
      </div>
    </div>

    <!-- Mobile Actions -->
    <div class="flex gap-3 pt-4 border-t border-ui-border">
      {
        currentBrands.length > 0 && (
          <a
            href={`${Astro.url.pathname}?pageSize=${currentPageSize}`}
            class="flex-1 py-3 px-4 border border-ui-button-border text-ui-button-border rounded-sm hover:bg-ui-button-hover transition-colors text-center"
          >
            Clear Filters
          </a>
        )
      }
      <button
        type="submit"
        class="flex-1 py-3 px-4 bg-ui-button-surface text-ui-button-text rounded-sm hover:bg-ui-button-primary-hover transition-colors font-medium"
        id="mobile-apply-filters"
      >
        Apply Filters
      </button>
    </div>
  </form>
</div>

<script>
  class FilterManager {
    private mobileToggle: HTMLElement | null;
    private mobileDrawer: HTMLElement | null;
    private mobileOverlay: HTMLElement | null;
    private mobileClose: HTMLElement | null;
    private desktopFilterTimeout: number | null = null;

    constructor() {
      this.mobileToggle = document.getElementById("mobile-filter-toggle");
      this.mobileDrawer = document.getElementById("mobile-filter-drawer");
      this.mobileOverlay = document.getElementById("mobile-filter-overlay");
      this.mobileClose = document.getElementById("mobile-filter-close");

      this.setupDesktopFilters();
      this.setupMobileDrawer();
      this.setupShowMoreToggles();
    }

    private setupDesktopFilters(): void {
      const desktopForm = document.getElementById(
        "desktop-filter-form"
      ) as HTMLFormElement;
      if (!desktopForm) return;

      // Desktop: Apply filters after brief delay (batch approach)
      const checkboxes = desktopForm.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach((checkbox) => {
        checkbox.addEventListener("change", () => {
          // Clear existing timeout
          if (this.desktopFilterTimeout) {
            clearTimeout(this.desktopFilterTimeout);
          }

          // Set new timeout for batch filtering
          this.desktopFilterTimeout = window.setTimeout(() => {
            this.submitFilters(desktopForm);
          }, 800); // 800ms delay for batch selection
        });
      });
    }

    private setupMobileDrawer(): void {
      // Mobile drawer controls - ONLY for open/close
      this.mobileToggle?.addEventListener("click", () => this.openDrawer());
      this.mobileOverlay?.addEventListener("click", () => this.closeDrawer());
      this.mobileClose?.addEventListener("click", () => this.closeDrawer());

      // Mobile form submission - ONLY when Apply button clicked
      const mobileForm = document.getElementById(
        "mobile-filter-form"
      ) as HTMLFormElement;
      const applyButton = document.getElementById("mobile-apply-filters");

      if (mobileForm && applyButton) {
        applyButton.addEventListener("click", (e) => {
          e.preventDefault();
          this.submitFilters(mobileForm);
          this.closeDrawer();
        });
      }
    }

    private setupShowMoreToggles(): void {
      // Desktop show more/less - ONLY controls visibility
      const desktopButton = document.getElementById("desktop-show-more-brands");
      if (desktopButton) {
        const hiddenCount = parseInt(desktopButton.dataset.hiddenCount || "0");
        this.setupToggle(desktopButton, ".brand-extra-option", hiddenCount);
      }

      // Mobile show more/less - ONLY controls visibility
      const mobileButton = document.getElementById("mobile-show-more-brands");
      if (mobileButton) {
        const hiddenCount = parseInt(mobileButton.dataset.hiddenCount || "0");
        this.setupToggle(
          mobileButton,
          ".mobile-brand-extra-option",
          hiddenCount
        );
      }
    }

    private setupToggle(
      button: HTMLElement,
      optionSelector: string,
      hiddenCount: number
    ): void {
      let isExpanded = false;
      const extraOptions = document.querySelectorAll(optionSelector);

      button.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();

        if (isExpanded) {
          extraOptions.forEach((option) => option.classList.add("hidden"));
          button.textContent = `+ Show ${hiddenCount} more`;
        } else {
          extraOptions.forEach((option) => option.classList.remove("hidden"));
          button.textContent = "- Show less";
        }
        isExpanded = !isExpanded;
      });
    }

    private submitFilters(form: HTMLFormElement): void {
      const grid = document.getElementById("filterable-product-grid");
      if (!grid) return;

      // Store current scroll position for smooth transition
      const currentScroll = window.pageYOffset;
      sessionStorage.setItem("pre-filter-scroll", currentScroll.toString());

      // Dim results with smooth transition
      grid.style.transition = "opacity 0.4s ease";
      grid.style.opacity = "0.6";

      sessionStorage.setItem("filtering-in-progress", "true");

      // Smooth scroll to top before submitting
      window.scrollTo({
        top: 0,
        behavior: "smooth",
      });

      // Submit after scroll animation
      setTimeout(() => {
        form.submit();
      }, 300);
    }

    private openDrawer(): void {
      this.mobileOverlay?.classList.remove("pointer-events-none", "opacity-0");
      this.mobileDrawer?.classList.remove("translate-y-full");
      document.body.style.overflow = "hidden";
    }

    private closeDrawer(): void {
      this.mobileOverlay?.classList.add("opacity-0");
      this.mobileDrawer?.classList.add("translate-y-full");

      setTimeout(() => {
        this.mobileOverlay?.classList.add("pointer-events-none");
      }, 300);

      document.body.style.overflow = "";
    }
  }

  document.addEventListener("astro:page-load", () => {
    new FilterManager();
  });
</script>

<style>
  /* Smooth scrolling */
  html {
    scroll-behavior: smooth;
  }

  /* Checkbox styling */
  .elco-checkbox {
    accent-color: var(--ui-accent);
  }

  .elco-checkbox:focus {
    outline: 2px solid var(--ui-accent);
    outline-offset: 2px;
  }

  /* Smooth transitions */
  .brand-extra-option,
  .mobile-brand-extra-option {
    transition: all 0.2s ease;
  }

  /* Reduce motion for accessibility */
  @media (prefers-reduced-motion: reduce) {
    html {
      scroll-behavior: auto;
    }

    .brand-extra-option,
    .mobile-brand-extra-option {
      transition: none !important;
    }
  }
</style>
