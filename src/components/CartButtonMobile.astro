---
// Mobile-optimized CartButton fallback
// Lightweight version for mobile devices without desktop features
import { Icon } from "astro-icon/components";
import { cart } from "@/lib/cart";

const cartCount = cart.getItemCount();
---

<a
  href="/cart"
  class="relative p-2 inline-flex items-center"
  aria-label="Shopping Cart"
  id="mobile-cart-button"
>
  <Icon class="h-6 w-6 m-1" name="uil:shopping-cart" />
  <span
    id="mobile-cart-count"
    class:list={[
      "absolute top-1 right-0 bg-(--ui-button-surface) text-(--ui-button-text) text-xs rounded-full w-4 h-4 flex items-center justify-center",
      { hidden: cartCount === 0 },
    ]}
  >
    {cartCount}
  </span>
</a>

<script>
  // Initialize with server-rendered count to prevent initial flash
  let lastKnownCount: number | null = (() => {
    const countElement = document.getElementById("mobile-cart-count");
    return countElement ? parseInt(countElement.textContent || "0", 10) : null;
  })();

  // Minimal cart count updates for mobile
  function updateMobileCartCount(force = false) {
    const countElement = document.getElementById("mobile-cart-count");
    if (!countElement) return;

    import("@/lib/cart").then(({ cart }) => {
      const count = cart.getItemCount();

      // Only update DOM if count actually changed (prevents flash)
      if (force || lastKnownCount !== count) {
        countElement.textContent = count.toString();
        countElement.classList.toggle("hidden", count === 0);
        lastKnownCount = count;
      }
    }).catch(err => {
      console.error("Cart count update failed:", err);
    });
  }

  // Update cart count when cart is actually modified
  window.addEventListener("cartUpdated", () => updateMobileCartCount(true));

  // On page load, only update if different (prevents flash during filtering)
  document.addEventListener("astro:page-load", () => updateMobileCartCount(false));
</script>
