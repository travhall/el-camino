---
// src/components/AppliedFilters.astro
import { FilterCoordinator } from "@/lib/filterCoordinator";

export interface Props {
  classes?: string;
}

const { classes } = Astro.props;

// Parse current filters from URL
const currentParams = new URLSearchParams(Astro.url.search);
const currentBrands = currentParams.getAll("brands") || [];
const currentAvailability = currentParams.get("availability") === "true";

// Only show content if there are active filters
const hasActiveFilters = currentBrands.length > 0 || currentAvailability;

// Determine if we should start hidden (for animation) based on referrer
// If the referrer has no query params, this is the first filter being applied
// Note: Edge cases (direct URL entry, external navigation) are handled gracefully
// by JavaScript's session storage tracking in filterCoordinator.ts
const referrer = Astro.request.headers.get('referer') || '';
const referrerUrl = referrer ? new URL(referrer) : null;
const hadFiltersInReferrer = referrerUrl?.search ? referrerUrl.searchParams.toString().length > 0 : false;
const shouldStartHidden = hasActiveFilters && !hadFiltersInReferrer;
---

<style>
  .applied-filters-container {
    margin-bottom: 0.5rem;
    /* Transition is controlled by JavaScript - not CSS */
    /* This prevents unwanted animations on every filter change */
  }

  .applied-filters-container.no-filters {
    opacity: 0;
    pointer-events: none;
    visibility: hidden;
  }

  /* Prevent View Transition from animating AppliedFilters during filter changes */
  /* This allows JavaScript to have full control over animation timing */
  @media (prefers-reduced-motion: no-preference) {
    html::view-transition-old(applied-filters),
    html::view-transition-new(applied-filters) {
      animation: none !important;
      transition: none !important;
    }
  }
</style>

<div
  id="applied-filters-container"
  class:list={[
    "applied-filters-container px-2",
    classes,
    !hasActiveFilters ? "no-filters" : "",
  ]}
  style={`view-transition-name: applied-filters; ${shouldStartHidden ? 'visibility: hidden; opacity: 0;' : ''}`}
>
  <div class="flex flex-wrap items-center gap-3 my-2">
    {
      hasActiveFilters && (
        <>
          <div class="flex flex-wrap gap-2">
            {currentBrands.map((brand) => (
              <button
                type="button"
                data-remove-brand={brand}
                class="inline-flex items-center px-2.5 py-1.5 text-sm border rounded-full bg-(--surface-primary) hover:bg-(--surface-tertiary) transition-colors text-(--ui-input-text) border-(--ui-input-border)/50 group"
                title={`Remove ${brand} filter`}
              >
                <span>{brand}</span>
                <svg
                  class="w-3 h-3 ml-1 text-(--content-meta) group-hover:text-(--content-body)"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            ))}
            {currentAvailability && (
              <button
                type="button"
                data-remove-availability
                class="inline-flex items-center px-2.5 py-1.5 text-sm border rounded-full bg-(--surface-primary) hover:bg-(--surface-tertiary) transition-colors text-(--ui-input-text) border-(--ui-input-border)/50 group"
                title="Remove availability filter"
              >
                <span>In stock only</span>
                <svg
                  class="w-3 h-3 ml-1 text-(--state-success-text)/70 group-hover:text-(--state-success-text)"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            )}
          </div>
          <button
            type="button"
            data-clear-all-filters
            class="text-sm text-(--content-meta) hover:text-(--content-emphasis) transition-colors text-nowrap"
          >
            Clear All
          </button>
        </>
      )
    }
  </div>
</div>

<script>
  import { FilterCoordinator } from "@/lib/filterCoordinator";

  // Initialize the unified filter system
  FilterCoordinator.initialize();

  document.addEventListener("astro:page-load", () => {
    setupFilterHandlers();
  });

  function setupFilterHandlers() {
    // Individual brand removal
    document.querySelectorAll("[data-remove-brand]").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const target = e.currentTarget as HTMLElement;
        const brand = target?.dataset.removeBrand;
        if (brand) removeFilter("brand", brand);
      });
    });

    // Availability removal
    document
      .querySelector("[data-remove-availability]")
      ?.addEventListener("click", () => {
        removeFilter("availability");
      });

    // Clear All - use Astro navigation
    document
      .querySelector("[data-clear-all-filters]")
      ?.addEventListener("click", () => {
        const targetUrl = window.location.pathname;
        FilterCoordinator.coordinateExit(async () => {
          const { navigate } = await import('astro:transitions/client');
          navigate(targetUrl);
        }, targetUrl);
      });
  }

  async function removeFilter(type: string, value: string | null = null) {
    const currentParams = new URLSearchParams(window.location.search);
    const currentBrands = currentParams.getAll("brands") || [];
    const currentAvailability = currentParams.get("availability") === "true";

    const params = new URLSearchParams();

    if (type === "brand" && value) {
      const otherBrands = currentBrands.filter((b) => b !== value);
      otherBrands.forEach((brand) => params.append("brands", brand));
      if (currentAvailability) params.set("availability", "true");
    } else if (type === "availability") {
      currentBrands.forEach((brand) => params.append("brands", brand));
    }

    const queryString = params.toString();
    const url = `${window.location.pathname}${queryString ? "?" + queryString : ""}`;

    // Use Astro navigation to preserve transition:persist elements
    FilterCoordinator.coordinateExit(async () => {
      const { navigate } = await import('astro:transitions/client');
      navigate(url);
    }, url);
  }
</script>
