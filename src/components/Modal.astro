---
// src/components/Modal.astro
---

<script>
  // Add TypeScript declaration for modal functions
  declare global {
    interface Window {
      showModal(
        title: string,
        message: string,
        onConfirm: () => void,
        confirmText?: string,
        cancelText?: string
      ): void;
    }
  }

  // Modal manager
  const modalManager = {
    activeModal: null as HTMLElement | null,

    showModal(
      title: string,
      message: string,
      onConfirm: () => void,
      confirmText: string = "Confirm",
      cancelText: string = "Cancel"
    ): void {
      // Remove any existing modal
      this.closeModal();

      const portalRoot = document.getElementById("portal-root");
      if (!portalRoot) {
        console.error("Portal root not found!");
        return;
      }

      // Create modal backdrop
      const backdrop = document.createElement("div");
      backdrop.className =
        "fixed inset-0 bg-black bg-opacity-50 z-[9998] flex items-center justify-center p-4";
      backdrop.setAttribute("role", "dialog");
      backdrop.setAttribute("aria-modal", "true");
      backdrop.setAttribute("aria-labelledby", "modal-title");

      // Create modal content
      const modal = document.createElement("div");
      modal.className =
        "bg-surface-primary border border-border-primary rounded-lg shadow-lg max-w-md w-full max-h-[90vh] overflow-y-auto";

      modal.innerHTML = `
        <div class="p-6">
          <h2 id="modal-title" class="font-display text-xl mb-4 text-content-heading">
            ${title}
          </h2>
          <p class="text-content-body mb-6">
            ${message}
          </p>
          <div class="flex gap-3 justify-end">
            <button 
              id="modal-cancel" 
              class="font-sans font-semibold transition-all duration-300 border-2 rounded-[4px] text-sm py-2 px-3 lg:text-base lg:py-2 lg:px-4 text-ui-button-surface bg-ui-button-surface/0 border-ui-button-surface hover:bg-ui-button-surface/10"
            >
              ${cancelText}
            </button>
            <button 
              id="modal-confirm" 
              class="font-sans font-semibold transition-all duration-300 border-2 rounded-[4px] text-sm py-2 px-3 lg:text-base lg:py-2 lg:px-4 text-ui-button-text bg-ui-button-surface border-ui-button-border hover:bg-ui-button-surface/75"
            >
              ${confirmText}
            </button>
          </div>
        </div>
      `;

      backdrop.appendChild(modal);
      portalRoot.appendChild(backdrop);
      this.activeModal = backdrop;

      // Focus management
      const confirmButton = modal.querySelector(
        "#modal-confirm"
      ) as HTMLButtonElement;
      const cancelButton = modal.querySelector(
        "#modal-cancel"
      ) as HTMLButtonElement;

      confirmButton?.focus();

      // Event listeners
      const handleConfirm = () => {
        onConfirm();
        this.closeModal();
      };

      const handleCancel = () => {
        this.closeModal();
      };

      const handleKeydown = (e: KeyboardEvent) => {
        if (e.key === "Escape") {
          this.closeModal();
        }
        if (e.key === "Tab") {
          // Simple tab trapping between cancel and confirm buttons
          e.preventDefault();
          if (document.activeElement === confirmButton) {
            cancelButton?.focus();
          } else {
            confirmButton?.focus();
          }
        }
      };

      const handleBackdropClick = (e: MouseEvent) => {
        if (e.target === backdrop) {
          this.closeModal();
        }
      };

      confirmButton?.addEventListener("click", handleConfirm);
      cancelButton?.addEventListener("click", handleCancel);
      document.addEventListener("keydown", handleKeydown);
      backdrop.addEventListener("click", handleBackdropClick);

      // Store event listeners for cleanup
      backdrop.setAttribute("data-cleanup", "true");
      (backdrop as any)._cleanup = () => {
        confirmButton?.removeEventListener("click", handleConfirm);
        cancelButton?.removeEventListener("click", handleCancel);
        document.removeEventListener("keydown", handleKeydown);
        backdrop.removeEventListener("click", handleBackdropClick);
      };
    },

    closeModal(): void {
      if (this.activeModal) {
        // Call cleanup function if it exists
        if ((this.activeModal as any)._cleanup) {
          (this.activeModal as any)._cleanup();
        }
        this.activeModal.remove();
        this.activeModal = null;
      }
    },
  };

  // Assign to window object
  window.showModal = modalManager.showModal.bind(modalManager);

  // Cleanup on page navigation
  const cleanup = () => {
    modalManager.closeModal();
  };

  document.addEventListener("astro:before-swap", cleanup);

  if (import.meta.hot) {
    import.meta.hot.dispose(cleanup);
  }
</script>
