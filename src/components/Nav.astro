---
// src/components/Nav.astro - Clean, optimized version with performance cache
import { fetchCategoryHierarchy } from "@/lib/square/categories";
import { navigationCache } from "@/lib/square/navigationCache";
import { Icon } from "astro-icon/components";
import { siteConfig } from "@/lib/site-config";

const { contact, social } = siteConfig;

// Enhanced category fetching with 15-minute cache
let categoryHierarchy;
try {
  const navConfig = await navigationCache.getNavigationStructure();
  categoryHierarchy = navConfig?.items || (await fetchCategoryHierarchy());
} catch (error) {
  console.warn("Navigation cache failed, using standard fetch");
  categoryHierarchy = await fetchCategoryHierarchy();
}

// Static navigation items
const staticNavItems = [
  {
    category: {
      id: "shop",
      name: "The Shop",
      slug: "shop",
      isTopLevel: true,
      parentCategoryId: undefined,
      rootCategoryId: undefined,
    },
    subcategories: [],
  },
  {
    category: {
      id: "news",
      name: "News",
      slug: "news",
      isTopLevel: true,
      parentCategoryId: undefined,
      rootCategoryId: undefined,
    },
    subcategories: [],
  },
];

// Combine navigation items
const navItems = [
  staticNavItems[0], // "The Shop" first
  ...categoryHierarchy, // Categories with products
  staticNavItems[1], // "News" last
];
---

<!-- Skip to content link -->
<a href="#main-content" class="skip-link">Skip to main content</a>

<nav
  class="flex flex-col md:flex-row w-full lg:gap-2 pt-32 md:pt-0 justify-center border-4 border-border-secondary md:border-0 bg-surface-secondary md:relative md:top-auto fixed -translate-x-full md:translate-x-0 transition-transform duration-400 ease-in-out inset-0 top-[3rem] z-40 [&.nav-open]:translate-x-0 overflow-y-auto md:overflow-visible"
  role="navigation"
  aria-label="Main navigation"
>
  {
    navItems.map((item, index) => (
      <div class="category-group relative flex flex-col md:flex-row group transition-all">
        <a
          href={
            item.category.id === "shop"
              ? "/shop"
              : item.category.id === "news"
                ? "/news"
                : `/category/${item.category.slug}`
          }
          class="nav-item text-3xl md:text-lg lg:text-xl font-semibold font-display self-start md:self-center items-center flex flex-row leading-[1] p-4 text-ui-nav-text transition-all duration-300 ease-in-out relative md:hover:text-ui-nav-hover before:absolute before:top-0 before:left-0 before:w-full before:h-0.5 before:bg-ui-nav-hover before:transform before:scale-x-0 before:origin-right before:transition-transform before:duration-300 before:ease-in-out md:hover:before:scale-x-100 md:hover:before:origin-left nav-link"
          style={`--item-index: ${index};`}
          data-has-children={item.subcategories.length > 0}
          aria-expanded={item.subcategories.length > 0 ? "false" : undefined}
          aria-haspopup={item.subcategories.length > 0 ? "menu" : undefined}
        >
          {item.category.name}
          {item.subcategories.length > 0 && (
            <span class="dropdown-indicator block ml-1 transition-transform duration-200">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="12"
                height="12"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="hidden md:block transform md:group-hover:rotate-180"
                aria-hidden="true"
              >
                <polyline points="6 9 12 15 18 9" />
              </svg>

              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 48 48"
                fill="none"
                stroke="currentColor"
                stroke-width="4"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="md:hidden mobile-caret"
                aria-hidden="true"
              >
                <polyline points="12 18 24 30 36 18" />
              </svg>
            </span>
          )}
        </a>

        {/* Dropdown menu */}
        {item.subcategories.length > 0 && (
          <div class="dropdown-menu md:hidden md:group-hover:block absolute left-0 top-full z-50 min-w-[200px] md:opacity-100 md:transition-none">
            <div class="bg-ui-nav-surface border border-ui-nav-border/20 shadow-lg rounded-sm p-1 overflow-hidden">
              {item.subcategories.map((subcategory) => (
                <a
                  href={
                    item.category.id === "shop"
                      ? `/shop/${subcategory.slug}`
                      : `/category/${item.category.slug}/${subcategory.slug}`
                  }
                  class="block px-4 py-2 text-xl md:text-base text-ui-nav-text hover:bg-ui-nav-hover/20 hover:text-ui-nav-text transition-all duration-300 ease-in-out"
                >
                  {subcategory.name}
                </a>
              ))}
            </div>
          </div>
        )}
      </div>
    ))
  }

  {/* Mobile footer */}
  <div
    class="flex flex-col gap-2 p-4 pt-12 border-t border-ui-nav-border/20 mt-6 md:hidden nav-link"
    style="--item-index: 6;"
  >
    <address class="flex flex-col gap-2 uppercase not-italic text-ui-nav-text">
      <span class="font-semibold">{siteConfig.name}</span>
      <span>{contact.address.street}</span>
      <span
        >{contact.address.city}, {contact.address.state}
        {contact.address.zip}</span
      >
      <a
        href={`tel:${contact.phone.number}`}
        class="mt-2 hover:underline decoration-double underline-offset-4 decoration-ui-button-surface transition-all"
      >
        {contact.phone.display}
      </a>
      <a
        href={`mailto:${contact.email}`}
        class="mt-2 hover:underline decoration-double underline-offset-4 decoration-ui-button-surface transition-all"
      >
        {contact.email}
      </a>
    </address>

    <ul class="inline-flex flex-row gap-4 mt-3">
      {
        social.map((item) => (
          <li>
            <a
              href={item.url}
              aria-label={item.platform}
              class="text-ui-nav-text hover:text-ui-nav-hover"
              target="_blank"
              rel="noopener"
            >
              <Icon name={item.icon} class="w-5 h-auto" />
            </a>
          </li>
        ))
      }
    </ul>
  </div>
</nav>

<style>
  /* Skip link */
  .skip-link {
    position: absolute;
    top: -40px;
    left: 6px;
    background: rgb(var(--ui-nav-surface-rgb));
    color: rgb(var(--ui-nav-text-rgb));
    padding: 8px;
    text-decoration: none;
    border-radius: 4px;
    border: 2px solid rgb(var(--ui-nav-hover-rgb));
    z-index: 100;
    font-weight: 600;
    transition: top 0.3s;
  }

  .skip-link:focus {
    top: 6px;
  }

  nav {
    view-transition-name: nav;
  }

  /* Mobile animations */
  @media (max-width: 768px) {
    .nav-link {
      opacity: 0;
      transform: translateX(2rem);
    }

    nav.nav-open .nav-link {
      animation: slideIn 0.5s ease forwards;
      animation-delay: calc(var(--item-index) * 0.1s);
    }

    .dropdown-menu {
      position: static;
      max-height: 0;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease-in-out;
      overflow: hidden;
      background-color: rgba(var(--ui-nav-hover-rgb, 255, 255, 255), 0.05);
      border-left: 2px solid rgba(var(--ui-nav-border-rgb, 255, 255, 255), 0.1);
      padding-left: 0.5rem;
      border-radius: 0 0 4px 4px;
    }

    .dropdown-menu > div {
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 0.5rem 0;
    }

    .category-group.open .dropdown-menu {
      display: block;
      max-height: 500px;
      opacity: 1;
      transform: translateY(0);
    }

    .category-group.open .mobile-caret {
      transform: rotate(180deg);
    }

    @keyframes slideIn {
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
  }

  /* Focus styles */
  .nav-item:focus-visible {
    outline: 2px solid rgb(var(--ui-nav-hover-rgb));
    outline-offset: 2px;
    border-radius: 0.25rem;
  }

  .dropdown-menu a:focus-visible {
    outline: 2px solid rgb(var(--ui-nav-hover-rgb));
    outline-offset: -2px;
    border-radius: 0.25rem;
  }
</style>

<script>
  function setupNavigation() {
    const categoryGroups = document.querySelectorAll(".category-group");

    categoryGroups.forEach((group) => {
      const link = group.querySelector(".nav-item");
      const dropdown = group.querySelector(".dropdown-menu");
      const hasChildren = link?.getAttribute("data-has-children") === "true";

      if (hasChildren && link && dropdown) {
        // Mobile click toggle
        link.addEventListener("click", (event: Event) => {
          if (window.innerWidth <= 768) {
            event.preventDefault();

            // Close others
            categoryGroups.forEach((otherGroup) => {
              if (
                otherGroup !== group &&
                otherGroup.classList.contains("open")
              ) {
                otherGroup.classList.remove("open");
                const otherLink = otherGroup.querySelector(
                  ".nav-item"
                ) as HTMLElement;
                if (otherLink) otherLink.setAttribute("aria-expanded", "false");
              }
            });

            // Toggle current
            const isOpen = group.classList.contains("open");
            if (isOpen) {
              group.classList.remove("open");
              link.setAttribute("aria-expanded", "false");
            } else {
              group.classList.add("open");
              link.setAttribute("aria-expanded", "true");
            }
          }
        });

        // Focus management for hover + tab workflow
        const dropdownLinks = dropdown.querySelectorAll("a");
        dropdownLinks.forEach((dropdownLink) => {
          dropdownLink.addEventListener("focus", () => {
            group.classList.add("open");
            link.setAttribute("aria-expanded", "true");
          });
        });

        // Close when focus leaves
        group.addEventListener("focusout", (event) => {
          setTimeout(() => {
            if (!group.contains(document.activeElement)) {
              group.classList.remove("open");
              link.setAttribute("aria-expanded", "false");
            }
          }, 0);
        });
      }
    });
  }

  function resetNavItems() {
    const navLinks = document.querySelectorAll(".nav-link");
    navLinks.forEach((link) => {
      const element = link as HTMLElement;
      element.style.opacity = "";
      element.style.transform = "";
    });

    document.querySelectorAll(".category-group.open").forEach((group) => {
      group.classList.remove("open");
    });
  }

  // Mobile animation observer
  const nav = document.querySelector("nav");
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === "class") {
        if (!nav?.classList.contains("nav-open")) {
          setTimeout(resetNavItems, 300);
        }
      }
    });
  });

  if (nav) {
    observer.observe(nav, { attributes: true });
  }

  // Page transitions
  document.addEventListener("astro:before-swap", () => {
    observer.disconnect();
  });

  document.addEventListener("astro:after-swap", () => {
    const newNav = document.querySelector("nav");
    if (newNav) {
      observer.observe(newNav, { attributes: true });
    }
    setupNavigation();
  });

  // Initialize
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", setupNavigation);
  } else {
    setupNavigation();
  }
</script>
