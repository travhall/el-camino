---
// src/pages/cart.astro
import Layout from "@/layouts/Layout.astro";
import Button from "@/components/Button.astro";
import FulfillmentSelector from "@/components/FulfillmentSelector.astro";
---

<Layout title="Your Shopping Cart | El Camino">
  <section class="p-1 pb-0">
    <h1
      class="font-display font-black text-6xl lg:text-7xl xl:text-8xl 2xl:text-9xl leading-[0.8] text-(--content-heading) p-3 pb-0 -mb-4"
    >
      Cart
    </h1>

    <!-- Loading/Content Container -->
    <div
      id="cart-loading"
      class="text-center min-h-[90dvh] flex items-center justify-center py-12"
    >
      <div
        class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-(--content-heading)"
      >
      </div>
      <p class="mt-2 text-(--content-meta)">Loading cart...</p>
    </div>

    <!-- Empty Cart State -->
    <div
      id="empty-cart"
      class="hidden flex flex-col min-h-[90dvh] items-center justify-center"
    >
      <p class="text-lg mb-6 text-(--content-body)">Your cart is empty</p>
      <Button href="/shop/all" variant="outline"> Continue Shopping </Button>
    </div>

    <!-- Cart Content Grid -->
    <div id="cart-content" class="hidden grid md:grid-cols-3 gap-1 items-start">
      <!-- Cart Items Column -->
      <div class="md:col-span-2 space-y-1 grid pb-4">
        <!-- Fulfillment Selector -->
        <FulfillmentSelector subtotal={0} />
        <div class="flex justify-between items-center px-4">
          <h2 class="font-display text-3xl mb-2 text-(--content-heading)">
            Cart Items
          </h2>
          <Button
            id="clear-cart-button"
            variant="ghost"
            size="sm"
            classes="justify-self-end"
          >
            Clear Cart
          </Button>
        </div>
        <div id="cart-items-list" class="grid gap-1"></div>
      </div>

      <!-- Order Summary Column (Static) -->
      <div class="md:col-span-1 space-y-1">
        <!-- Order Summary -->
        <div class="bg-(--surface-secondary) p-4 sticky top-4">
          <h2 class="font-display text-3xl mb-2 text-(--content-heading)">
            Order Summary
          </h2>
          <div class="order-summary space-y-2 mb-4">
            <div class="flex justify-between text-(--content-body)">
              <span>Subtotal</span>
              <span
                class="font-display font-bold text-2xl text-(--content-caption)"
                id="subtotal">$0.00</span
              >
            </div>
            <div class="flex justify-between text-(--content-body)">
              <span>Sales Tax</span>
              <span class="font-semibold" id="tax-amount">$0.00</span>
            </div>
            <div
              class="flex justify-between text-(--content-body)"
              id="shipping-row"
            >
              <span>Shipping</span>
              <span class="font-semibold" id="shipping-cost">$0.00</span>
            </div>
            <div
              class="flex justify-between text-(--content-body) text-lg pt-2 border-t border-(--border-secondary)"
            >
              <span class="font-semibold">Order Total</span>
              <span
                class="font-display font-bold text-5xl text-(--content-heading)"
                id="order-total">$0.00</span
              >
            </div>
          </div>
          <div class="space-y-2">
            <Button
              id="checkout-button"
              variant="primary"
              classes="w-full"
              data-disabled="true"
            >
              Continue to Payment
            </Button>
            <Button
              href="/shop/all"
              variant="outline"
              classes="w-full text-center"
            >
              Continue Shopping
            </Button>
          </div>
        </div>
      </div>
    </div>

    <!-- Processing Indicator -->
    <div
      id="loading-overlay"
      class="fixed inset-0 bg-(--surface-primary)/50 min-h-[90dvh] items-center justify-center hidden z-50"
    >
      <div class="bg-(--surface-secondary) p-4 rounded-sm">
        <div class="flex items-center justify-center">
          <div
            class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-(--content-heading) mr-3"
          >
          </div>
          <p class="text-lg text-(--content-body)">Processing...</p>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  import { cart } from "@/lib/cart";
  import type { CartItem } from "@/lib/cart/types";
  import { MoneyUtils } from "@/lib/square/money";
  import { createSlug } from "@/lib/square/slugUtils";
  import {
    EL_CAMINO_LOGO_DATA_URI,
    EL_CAMINO_LOADER_DATA_URI,
  } from "@/lib/constants/assets";

  let isUpdating = false;
  let inventoryData: Record<string, number> = {};

  // Client-side image optimization for cart items
  function optimizeCartImage(src: string): string {
    if (!src || !src.includes("squarecdn.com")) {
      return src;
    }

    try {
      // Cart images: lg:w-24 = 96px, use 128px for retina quality
      const url = new URL(src);
      url.searchParams.set("w", "128");
      url.searchParams.set("h", "128");
      url.searchParams.set("fit", "crop");

      // Format detection matching EnhancedImageOptimizer
      if (typeof window !== "undefined") {
        const canvas = document.createElement("canvas");
        if (canvas.toDataURL("image/avif").indexOf("data:image/avif") === 0) {
          url.searchParams.set("fm", "avif");
          url.searchParams.set("q", "65");
        } else if (
          canvas.toDataURL("image/webp").indexOf("data:image/webp") === 0
        ) {
          url.searchParams.set("fm", "webp");
          url.searchParams.set("q", "85");
        } else {
          url.searchParams.set("fm", "jpg");
          url.searchParams.set("q", "90");
        }
      }

      return url.toString();
    } catch {
      return src;
    }
  }

  function setLoading(show: boolean): void {
    const overlay = document.getElementById("loading-overlay");
    if (overlay) {
      overlay.classList.toggle("hidden", !show);
      overlay.classList.toggle("flex", show);
    }
  }

  function showNotification(
    message: string,
    type: "success" | "error" = "success"
  ): void {
    // Use existing system if available
    if (typeof window !== "undefined" && (window as any).showNotification) {
      (window as any).showNotification(message, type);
      return;
    }
  }

  function showConfirmModal(
    title: string,
    message: string,
    onConfirm: () => void
  ): void {
    // Use existing modal system if available
    if (typeof window !== "undefined" && (window as any).showModal) {
      (window as any).showModal(title, message, onConfirm, "Remove", "Cancel");
      return;
    }

    // Fallback
    if (confirm(`${title}\n\n${message}`)) {
      onConfirm();
    }
  }

  async function loadInventoryData(items: CartItem[]): Promise<void> {
    if (items.length === 0) {
      inventoryData = {};
      return;
    }

    try {
      const variationIds = items.map((item) => item.variationId);
      const response = await fetch("/api/cart-inventory", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ variationIds }),
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const result = await response.json();
      if (result.success && result.inventory) {
        inventoryData = result.inventory;
      } else {
        throw new Error(result.error || "Failed to load inventory");
      }
    } catch (error) {
      console.error("Error loading inventory data:", error);
      inventoryData = {};
      items.forEach((item) => {
        inventoryData[item.variationId] = 99;
      });
    }
  }

  function createCartItem(item: CartItem): string {
    const itemKey = `${item.id}:${item.variationId}`;

    // Check for sale pricing
    const saleInfo = (item as any).saleInfo;
    const displayPrice = saleInfo?.salePrice || item.price;
    const itemSubtotal = displayPrice * item.quantity;

    const inventory = inventoryData[item.variationId] || 999;
    const isOutOfStock = inventory <= 0;
    const canIncrement = !isOutOfStock && item.quantity < inventory;

    // Generate slug-based URL to match other components
    const productSlug = createSlug(item.title);
    const productUrl = `/product/${productSlug}`;

    return `
      <div class="bg-(--surface-secondary) mx-4 p-4 flex gap-4 self-start" data-item-container="${itemKey}">
        <div class="shrink-0 relative w-16 h-16 lg:w-24 lg:h-24">
          <!-- Loading placeholder -->
          <div 
            class="loading-skeleton loading-image absolute inset-0 rounded transition-opacity duration-300"
            id="cart-placeholder-${itemKey}"
            aria-hidden="true"
          >
            <!-- El Camino logo using data URI -->
            <div 
              class="absolute inset-0 flex items-center justify-center rounded"
              style="background-image: url('${EL_CAMINO_LOADER_DATA_URI}'); background-size: auto; background-position: center; background-repeat: no-repeat; opacity: 0.7;"
            ></div>
          </div>
          
          <img 
            src="${item.image}"
            alt="${item.title}"
            class="absolute inset-0 w-full h-full object-cover rounded border border-(--border-secondary) opacity-0 transition-opacity duration-300" 
            loading="eager"
            onload="this.style.opacity='1'; document.getElementById('cart-placeholder-${itemKey}')?.remove();"
            onerror="this.src='${EL_CAMINO_LOGO_DATA_URI}'; this.style.opacity='1'; document.getElementById('cart-placeholder-${itemKey}')?.remove();"
          />
        </div>
        <div class="grow flex flex-col justify-between min-w-0">
          <div class="flex flex-row justify-between">
            <div class="flex flex-col mb-2 lg:mb-0">
              <h3 class="font-display text-2xl text-(--content-heading) leading-tight">
                <a href="${productUrl}" data-astro-prefetch="viewport" class="hover:text-(--content-emphasis) underline underline-offset-1 decoration-(--content-emphasis)/0 hover:decoration-(--content-emphasis)/80 hover:underline-offset-4 transition-all ease-in-out duration-300">
                  ${item.title}
                </a>
              </h3>
              ${
                item.variationName
                  ? `
                <p class="text-(--content-meta) text-sm mt-1 mb-3">${item.variationName}</p>
              `
                  : ""
              }
            </div>
            <div>
              <div class="text-right">
                ${
                  saleInfo
                    ? `
                  <div class="text-(--content-meta) text-xs line-through">
                    ${MoneyUtils.format(MoneyUtils.fromFloat(saleInfo.originalPrice))} each
                  </div>
                `
                    : `
                  <div class="text-(--content-meta) text-sm">
                    ${MoneyUtils.format(MoneyUtils.fromFloat(item.price))} each
                  </div>
                `
                }
                <div class="font-display font-bold text-2xl text-(--content-emphasis)">
                  ${MoneyUtils.format(MoneyUtils.fromFloat(itemSubtotal))}
                </div>
              </div>
            </div>
          </div>

          <div class="flex justify-between items-end gap-4">
            <div class="flex items-center gap-2">
              <label for="quantity-${itemKey}" class="text-sm text-(--content-body) hidden lg:block">Qty:</label>
              <div class="flex items-center border border-(--border-primary) rounded">
                <button 
                  type="button" 
                  class="quantity-increase px-2 py-1 border-2 rounded-sm transition-all ease-in-out duration-300 focus-visible:ring-2 outline-0 focus-visible:ring-offset-2 focus-visible:ring-offset-(--surface-primary) text-(--content-body) bg-(--surface-secondary) border-(--border-primary) hover:bg-(--surface-primary) ${item.quantity <= 1 ? "opacity-50 cursor-not-allowed" : ""}" 
                  data-item-key="${itemKey}"
                  data-action="decrease"
                  ${item.quantity <= 1 ? "disabled" : ""}
                >
                  −
                </button>
                <input 
                  type="number" 
                  id="quantity-${itemKey}" 
                  class="quantity-input w-16 text-center py-1 border-0 bg-(--surface-primary) text-(--content-body) focus-visible:ring-2 outline-0 focus-visible:ring-offset-2 focus-visible:ring-offset-(--surface-primary) [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none" 
                  value="${item.quantity}" 
                  min="1" 
                  max="${inventory}" 
                  data-item-key="${itemKey}"
                />
                <button 
                  type="button" 
                  class="quantity-increase px-2 py-1 border-2 rounded-sm transition-all ease-in-out duration-300 focus-visible:ring-2 outline-0 focus-visible:ring-offset-2 focus-visible:ring-offset-(--surface-primary) text-(--content-body) bg-(--surface-secondary) border-(--border-primary) hover:bg-(--surface-primary) ${!canIncrement ? "opacity-50 cursor-not-allowed" : ""}" 
                  data-item-key="${itemKey}"
                  data-action="increase"
                  ${!canIncrement ? "disabled" : ""}
                >
                  +
                </button>
              </div>
              <div class="text-xs text-(--content-meta)">
                ${inventory} available
              </div>
            </div>

            <div class="flex items-center gap-4">
              <button 
                type="button" 
                class="font-sans font-semibold text-xs lg:text-sm focus-visible:ring-2 outline-0 focus-visible:ring-offset-2 focus-visible:ring-offset-(--surface-primary) inline-flex items-center justify-center py-1 px-2 text-(--content-body) bg-none border-none focus-visible:ring-(--ui-button-ring) underline underline-offset-1 decoration-(--content-body)/0 hover:decoration-(--content-body)/80 hover:underline-offset-4 transition-all ease-in-out duration-300"
                data-item-key="${itemKey}"
                data-item-title="${item.title}"
                data-action="remove"
              >
                Remove
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  async function handleCheckout(): Promise<void> {
    try {
      const items = cart.getItems();
      if (items.length === 0) {
        showNotification("Your cart is empty", "error");
        return;
      }

      // Check if fulfillment method is selected
      const fulfillmentRadio = document.querySelector(
        'input[name="fulfillment"]:checked'
      ) as HTMLInputElement;

      if (!fulfillmentRadio) {
        // Scroll to fulfillment selector
        const selector = document.querySelector(
          '[data-component="fulfillment-selector"]'
        );
        selector?.scrollIntoView({ behavior: "smooth", block: "center" });

        // Add visual indication
        selector?.classList.add("border-4", "border-red-500", "rounded");
        setTimeout(() => {
          selector?.classList.remove("border-4", "border-red-500", "rounded");
        }, 3000);

        showNotification("Please choose a shipping method", "error");
        return;
      }

      const fulfillmentMethod = fulfillmentRadio.value as "shipping" | "pickup";

      let requestBody: any = { items, fulfillmentMethod };

      // Collect fulfillment details based on method
      if (fulfillmentMethod === "shipping") {
        const form = document.querySelector(
          "[data-shipping-form]"
        ) as HTMLElement;
        if (!form) {
          showNotification("Shipping form not found", "error");
          return;
        }

        // Validate required fields
        const requiredFields = form.querySelectorAll(
          "input[required], select[required]"
        );
        let isValid = true;
        requiredFields.forEach((field) => {
          const input = field as HTMLInputElement;
          if (!input.value.trim()) {
            isValid = false;
            input.classList.add("border-red-500");
          } else {
            input.classList.remove("border-red-500");
          }
        });

        if (!isValid) {
          showNotification(
            "Please fill in all required shipping fields",
            "error"
          );
          return;
        }

        requestBody.shippingAddress = {
          name: (form.querySelector("#ship-name") as HTMLInputElement).value,
          email: (form.querySelector("#ship-email") as HTMLInputElement).value,
          phone: (form.querySelector("#ship-phone") as HTMLInputElement).value,
          street1: (form.querySelector("#ship-street1") as HTMLInputElement)
            .value,
          street2:
            (form.querySelector("#ship-street2") as HTMLInputElement).value ||
            undefined,
          city: (form.querySelector("#ship-city") as HTMLInputElement).value,
          state: (form.querySelector("#ship-state") as HTMLSelectElement).value,
          zip: (form.querySelector("#ship-zip") as HTMLInputElement).value,
        };
      } else if (fulfillmentMethod === "pickup") {
        const form = document.querySelector(
          "[data-pickup-form]"
        ) as HTMLElement;
        if (!form) {
          showNotification("Pickup form not found", "error");
          return;
        }

        // Validate required fields
        const requiredFields = form.querySelectorAll("input[required]");
        let isValid = true;
        requiredFields.forEach((field) => {
          const input = field as HTMLInputElement;
          if (!input.value.trim()) {
            isValid = false;
            input.classList.add("border-red-500");
          } else {
            input.classList.remove("border-red-500");
          }
        });

        if (!isValid) {
          showNotification(
            "Please fill in all required pickup contact fields",
            "error"
          );
          return;
        }

        requestBody.pickupContact = {
          name: (form.querySelector("#pickup-name") as HTMLInputElement).value,
          email: (form.querySelector("#pickup-email") as HTMLInputElement)
            .value,
          phone: (form.querySelector("#pickup-phone") as HTMLInputElement)
            .value,
          instructions:
            (form.querySelector("#pickup-instructions") as HTMLTextAreaElement)
              ?.value || undefined,
        };
      }

      setLoading(true);

      const response = await fetch("/api/create-checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(requestBody),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error?.message || "Checkout failed");
      }

      if (!data.checkoutUrl) {
        throw new Error("No checkout URL returned");
      }

      showNotification("Redirecting to checkout...", "success");
      window.location.href = data.checkoutUrl;
    } catch (error) {
      showNotification(
        error instanceof Error
          ? error.message
          : "Checkout failed. Please try again.",
        "error"
      );
    } finally {
      setLoading(false);
    }
  }

  function handleClearCart(): void {
    const itemCount = cart.getItemCount();
    if (itemCount === 0) {
      showNotification("Cart is already empty", "error");
      return;
    }

    const items = cart.getItems();
    if (items.length === 1) {
      const item = items[0];
      showConfirmModal(
        "Remove Item",
        `Are you sure you want to remove "${item.title}" from your cart?`,
        async () => {
          cart.clear();
          await updateDisplay();
          showNotification("Cart cleared successfully");
        }
      );
    } else {
      showConfirmModal(
        "Clear Cart",
        `Are you sure you want to remove all ${itemCount} item${itemCount > 1 ? "s" : ""} from your cart?`,
        async () => {
          cart.clear();
          await updateDisplay();
          showNotification("Cart cleared successfully");
        }
      );
    }
  }

  function attachEventListeners(): void {
    const checkoutButton = document.getElementById("checkout-button");
    const clearCartButton = document.getElementById("clear-cart-button");

    if (checkoutButton) {
      checkoutButton.addEventListener("click", handleCheckout);
    }

    if (clearCartButton) {
      clearCartButton.addEventListener("click", handleClearCart);
    }
  }

  function setupCartItemEventListeners() {
    const cartItemsList = document.getElementById("cart-items-list");
    if (!cartItemsList) return;

    // Remove existing event listeners by cloning
    const newCartItemsList = cartItemsList.cloneNode(true) as HTMLElement;
    const parent = cartItemsList.parentNode;
    if (parent) {
      parent.replaceChild(newCartItemsList, cartItemsList);
    }

    // Add single event listener using delegation - SAME PATTERN AS MINICART
    newCartItemsList.addEventListener("click", async (e) => {
      const target = e.target as HTMLElement;
      const button = target.closest("button[data-action]") as HTMLButtonElement;
      if (!button || button.disabled) return;

      e.preventDefault();

      const action = button.dataset.action;
      const itemKey = button.dataset.itemKey;
      const itemTitle = button.dataset.itemTitle;

      if (!itemKey) return;

      try {
        switch (action) {
          case "increase":
            const items = cart.getItems();
            const item = items.find(
              (i: CartItem) => `${i.id}:${i.variationId}` === itemKey
            );
            if (item) {
              const newQty = item.quantity + 1;
              const inventory = inventoryData[item.variationId] || 999;

              if (newQty <= inventory) {
                await cart.updateQuantity(itemKey, newQty);
                await updateCartItemQuantity(itemKey);
              } else {
                showNotification(`Only ${inventory} available`, "error");
              }
            }
            break;

          case "decrease":
            const currentItems = cart.getItems();
            const currentItem = currentItems.find(
              (i: CartItem) => `${i.id}:${i.variationId}` === itemKey
            );
            if (currentItem) {
              if (currentItem.quantity === 1) {
                showConfirmModal(
                  "Remove Item",
                  `Remove "${currentItem.title}" from your cart?`,
                  async () => {
                    cart.removeItem(itemKey);
                    await updateDisplay();
                    showNotification("Item removed from cart", "success");
                  }
                );
              } else {
                await cart.updateQuantity(itemKey, currentItem.quantity - 1);
                await updateCartItemQuantity(itemKey);
              }
            }
            break;

          case "remove":
            if (itemTitle) {
              showConfirmModal(
                "Remove Item",
                `Remove "${itemTitle}" from your cart?`,
                async () => {
                  cart.removeItem(itemKey);
                  await updateDisplay();
                  showNotification("Item removed from cart", "success");
                }
              );
            }
            break;
        }
      } catch (error) {
        console.error("Error handling cart action:", error);
        showNotification("Error updating cart", "error");
      }
    });

    // Handle quantity input changes with debouncing
    let inputTimeout: number;
    newCartItemsList.addEventListener("input", (e) => {
      const target = e.target as HTMLInputElement;
      if (!target.classList.contains("quantity-input")) return;

      const itemKey = target.dataset.itemKey;
      if (!itemKey) return;

      clearTimeout(inputTimeout);
      inputTimeout = window.setTimeout(async () => {
        const newQuantity = parseInt(target.value, 10);

        if (newQuantity < 1) {
          target.value = "1";
          return;
        }

        const inventory = inventoryData[itemKey.split(":")[1]] || 999;
        if (newQuantity > inventory) {
          target.value = inventory.toString();
          showNotification(`Only ${inventory} available`, "error");
          return;
        }

        try {
          await cart.updateQuantity(itemKey, newQuantity);
          await updateCartItemQuantity(itemKey);
        } catch (error) {
          console.error("Error updating quantity:", error);
          showNotification("Error updating quantity", "error");
        }
      }, 500);
    });
  }

  async function updateCartItemQuantity(itemKey: string): Promise<void> {
    const items = cart.getItems();
    const item = items.find(
      (i: CartItem) => `${i.id}:${i.variationId}` === itemKey
    );

    if (!item) {
      // Item was removed, do full update
      await updateDisplay();
      return;
    }

    const inventory = inventoryData[item.variationId] || 999;
    // Use sale price if available, otherwise regular price
    const saleInfo = (item as any).saleInfo;
    const displayPrice = saleInfo?.salePrice || item.price;
    const itemSubtotal = displayPrice * item.quantity;
    const total = cart.getTotal();

    // Update quantity display
    const quantityInput = document.querySelector(
      `input[data-item-key="${itemKey}"]`
    ) as HTMLInputElement;
    if (quantityInput) {
      quantityInput.value = item.quantity.toString();
    }

    // Update item subtotal
    const itemContainer = document.querySelector(
      `[data-item-container="${itemKey}"]`
    );
    if (itemContainer) {
      const subtotalEl = itemContainer.querySelector(
        ".font-display.font-bold.text-2xl"
      );
      if (subtotalEl) {
        subtotalEl.textContent = MoneyUtils.format(
          MoneyUtils.fromFloat(itemSubtotal)
        );
      }

      // Update button states
      const decreaseBtn = itemContainer.querySelector(
        '[data-action="decrease"]'
      ) as HTMLButtonElement;
      const increaseBtn = itemContainer.querySelector(
        '[data-action="increase"]'
      ) as HTMLButtonElement;

      if (decreaseBtn) {
        decreaseBtn.disabled = item.quantity <= 1;
        decreaseBtn.classList.toggle("opacity-50", item.quantity <= 1);
        decreaseBtn.classList.toggle("cursor-not-allowed", item.quantity <= 1);
      }

      if (increaseBtn) {
        const canIncrement = item.quantity < inventory;
        increaseBtn.disabled = !canIncrement;
        increaseBtn.classList.toggle("opacity-50", !canIncrement);
        increaseBtn.classList.toggle("cursor-not-allowed", !canIncrement);
      }
    }

    // Update cart total
    const subtotalEl = document.getElementById("subtotal");
    if (subtotalEl) {
      subtotalEl.textContent = MoneyUtils.format(MoneyUtils.fromFloat(total));
    }

    // Update order summary
    updateOrderSummary(total);
  }

  async function updateOrderSummary(subtotal: number): Promise<void> {
    // Get selected fulfillment method
    const fulfillmentRadio = document.querySelector(
      'input[name="fulfillment"]:checked'
    ) as HTMLInputElement;

    const subtotalEl = document.getElementById("subtotal");
    const taxEl = document.getElementById("tax-amount");
    const shippingEl = document.getElementById("shipping-cost");
    const totalEl = document.getElementById("order-total");

    // Always show subtotal
    if (subtotalEl) {
      subtotalEl.textContent = MoneyUtils.format(
        MoneyUtils.fromFloat(subtotal)
      );
    }

    // If no method selected, show placeholder values
    if (!fulfillmentRadio) {
      if (taxEl) taxEl.textContent = "—";
      if (shippingEl) shippingEl.textContent = "—";
      if (totalEl) {
        totalEl.textContent = MoneyUtils.format(MoneyUtils.fromFloat(subtotal));
      }
      return;
    }

    const fulfillmentMethod = fulfillmentRadio.value as "shipping" | "pickup";

    try {
      // Call Square CalculateOrder API to get real tax
      const response = await fetch("/api/calculate-cart", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          items: cart.getItems(),
          fulfillmentMethod,
        }),
      });

      const data = await response.json();

      if (!data.success) {
        throw new Error(data.error || "Calculation failed");
      }

      // Use Square-calculated values
      const shippingCost = data.shipping;
      const taxAmount = data.tax;
      const orderTotal = data.total;

      // Format shipping display
      const shippingDisplay =
        shippingCost === 0 ? "FREE" : `$${shippingCost.toFixed(2)}`;

      // Update displays
      const subtotalEl = document.getElementById("subtotal");
      const taxEl = document.getElementById("tax-amount");
      const shippingEl = document.getElementById("shipping-cost");
      const totalEl = document.getElementById("order-total");

      if (subtotalEl) {
        subtotalEl.textContent = MoneyUtils.format(
          MoneyUtils.fromFloat(subtotal)
        );
      }
      if (taxEl) {
        taxEl.textContent = `$${taxAmount.toFixed(2)}`;
      }
      if (shippingEl) {
        shippingEl.textContent = shippingDisplay;
      }
      if (totalEl) {
        totalEl.textContent = `$${orderTotal.toFixed(2)}`;
      }

      // Update free shipping tracker
      if (typeof (window as any).updateFreeShippingTracker === "function") {
        (window as any).updateFreeShippingTracker(subtotal);
      }
    } catch (error) {
      console.error("Error calculating order summary:", error);
      // Fallback to showing subtotal at minimum
      const subtotalEl = document.getElementById("subtotal");
      if (subtotalEl) {
        subtotalEl.textContent = MoneyUtils.format(
          MoneyUtils.fromFloat(subtotal)
        );
      }
    }
  }

  async function updateDisplay(): Promise<void> {
    if (isUpdating) return;
    isUpdating = true;

    try {
      const items = cart.getItems();
      const total = cart.getTotal();

      await loadInventoryData(items);

      const cartLoading = document.getElementById("cart-loading");
      const emptyCart = document.getElementById("empty-cart");
      const cartContent = document.getElementById("cart-content");
      const cartItemsList = document.getElementById("cart-items-list");
      const subtotalEl = document.getElementById("subtotal");

      if (!emptyCart || !cartContent || !cartItemsList || !subtotalEl) return;

      if (cartLoading) cartLoading.classList.add("hidden");

      if (items.length === 0) {
        // Show empty state
        emptyCart.classList.remove("hidden");
        cartContent.classList.add("hidden");
      } else {
        // Show cart with items
        emptyCart.classList.add("hidden");
        cartContent.classList.remove("hidden");

        // Update items list
        const cartItemsHtml = items.map(createCartItem).join("");
        cartItemsList.innerHTML = cartItemsHtml;

        // Update subtotal
        subtotalEl.textContent = MoneyUtils.format(MoneyUtils.fromFloat(total));

        setupCartItemEventListeners();

        // Update order summary with tax, shipping, total
        updateOrderSummary(total);
      }
    } catch (error) {
      console.error("Error updating cart display:", error);
    } finally {
      isUpdating = false;
    }
  }

  function setupFulfillmentListeners(): void {
    const checkoutButton = document.getElementById(
      "checkout-button"
    ) as HTMLButtonElement;

    // Initially disable checkout button
    if (checkoutButton) {
      checkoutButton.disabled = true;
      checkoutButton.classList.add("opacity-50", "cursor-not-allowed");
    }

    // Listen for radio changes (triggered by card selection)
    const fulfillmentRadios = document.querySelectorAll(
      'input[name="fulfillment"]'
    );
    fulfillmentRadios.forEach((radio) => {
      radio.addEventListener("change", () => {
        // Enable checkout button when selection is made
        if (checkoutButton) {
          checkoutButton.disabled = false;
          checkoutButton.classList.remove("opacity-50", "cursor-not-allowed");
        }

        const total = cart.getTotal();
        updateOrderSummary(total);
      });
    });

    // Make update function available globally for FulfillmentSelector
    (window as any).updateOrderSummaryOnFulfillmentChange = () => {
      const total = cart.getTotal();
      updateOrderSummary(total);
    };
  }

  function handlePageLoad() {
    attachEventListeners();
    updateDisplay();
    setupFulfillmentListeners();
  }

  document.addEventListener("astro:page-load", handlePageLoad);

  if (import.meta.hot) {
    import.meta.hot.dispose(() => {
      document.removeEventListener("astro:page-load", handlePageLoad);
    });
  }
</script>
