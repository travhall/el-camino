---
import Layout from "@/layouts/Layout.astro";
import Button from "@/components/Button.astro";
import Modal from "@/components/Modal.astro";
import { fetchProduct } from "@/lib/square/client";
import { MoneyUtils } from "@/lib/square/money";
import { checkBulkInventory } from "@/lib/square/inventory";
import {
  createInitialSelectionState,
  getAttributeDisplayName,
} from "@/lib/square/variationParser";
import { fetchProducts } from "@/lib/square/client";
import {
  extractIdFromSlug,
  createSlug,
  getVariationFromVariantParam,
  createSEOTitle,
  createSlugMapping,
} from "@/lib/square/slugUtils";

// Get the slug from URL params (note: still called 'id' because file is [id].astro)
const { id: slug } = Astro.params;
const variantParam = Astro.url.searchParams.get("variant");

if (!slug) {
  return Astro.redirect("/404");
}

// Create slug mapping (in production, this should be cached/built at build time)
const allProducts = await fetchProducts();
const slugMapping = createSlugMapping(allProducts);

// Get Square ID from slug
const id = extractIdFromSlug(slug, slugMapping);

if (!id) {
  console.error(`No ID found for slug: ${slug}`);
  return Astro.redirect("/404");
}

// Fetch product data
const product = await fetchProduct(id);
if (!product) {
  console.error(`Product not found for ID: ${id}`);
  return Astro.redirect("/404");
}

// Handle old ID-only URLs - redirect to new format
if (slug === id) {
  const productSlug = createSlug(product.title);
  return Astro.redirect(`/product/${productSlug}`, 301);
}

// Handle variant parameter
if (variantParam && product.variations) {
  const targetVariation = getVariationFromVariantParam(product, variantParam);

  if (targetVariation) {
    // Update product with selected variant
    product.selectedVariationId = targetVariation.variationId;
    product.price = targetVariation.price;
    if (targetVariation.image) {
      product.image = targetVariation.image;
    }
  } else {
    // Invalid variant parameter - redirect to base product
    const baseSlug = createSlug(product.title);
    return Astro.redirect(`/product/${baseSlug}`, 301);
  }
}

if (!product) {
  return Astro.redirect("/404");
}

// Set default variation ID and prepare for inventory checking
let defaultVariationId = product.variationId;
let variations = product.variations || [];
let inventoryMap: Record<string, number> = {};

// Check inventory for all variations at once
if (variations.length > 0) {
  try {
    // Get all variation IDs for batch inventory check
    const variationIds = variations.map((v) => v.variationId);

    // Get inventory for all variations in a single request
    inventoryMap = await checkBulkInventory(variationIds);

    // Update variation data with inventory information
    variations = variations.map((v) => ({
      ...v,
      inStock: (inventoryMap[v.variationId] || 0) > 0,
      quantity: inventoryMap[v.variationId] || 0,
    }));

    // Check if default variation is in stock
    const defaultIsInStock = (inventoryMap[defaultVariationId] || 0) > 0;

    // If default is out of stock, find first in-stock variation
    if (!defaultIsInStock && variations.length > 0) {
      const firstInStockVariation = variations.find((v) => v.inStock);
      if (firstInStockVariation) {
        defaultVariationId = firstInStockVariation.variationId;
        // Use variation-specific image if available
        if (firstInStockVariation.image) {
          product.image = firstInStockVariation.image;
        }
      }
    }
  } catch (err) {
    console.error(
      `Inventory check error: ${err instanceof Error ? err.message : String(err)}`
    );
    // Default to allowing purchases if inventory check fails
    variations = variations.map((v) => ({
      ...v,
      inStock: true,
      quantity: 999,
    }));
  }
} else {
  // Single variation product - mark as in stock by default
  const quantity = inventoryMap[product.variationId] || 999;
  variations = [
    {
      id: product.variationId,
      variationId: product.variationId,
      name: product.title,
      price: product.price,
      inStock: quantity > 0,
      quantity: quantity,
      attributes: {}, // Add empty attributes for consistency
    },
  ];
}

// Create initial selection state using the parser
const selectionState = createInitialSelectionState(variations);
const availableAttributes = selectionState.availableAttributes;
const attributeTypes = Object.keys(availableAttributes);

// Find selected variation
const selectedVariation =
  variations.find((v) => v.variationId === defaultVariationId) || variations[0];
const selectedVariationInStock = selectedVariation?.inStock || false;
const selectedVariationQuantity = selectedVariation?.quantity || 0;
const formattedPrice = MoneyUtils.format(
  MoneyUtils.fromFloat(selectedVariation?.price || product.price)
);

// Check if we have multiple variations
const hasMultipleVariations = variations.length > 1;

// Set product metadata
const pageTitle = product.title;
const selectedVariationForSEO =
  variantParam && product.variations
    ? product.variations.find(
        (v) => v.variationId === product.selectedVariationId
      )
    : undefined;
const fullTitle = createSEOTitle(product, selectedVariationForSEO);
const unitDisplay = selectedVariation?.unit || product.unit || "";
---

<Layout title={fullTitle}>
  <section class="p-4 sm:p-6 lg:p-8 relative">
    <div
      class="lg:grid lg:grid-cols-2 lg:gap-x-8 xl:gap-x-12 2xl:gap-x-16 items-start"
    >
      <!-- Product Image -->
      <div
        class="aspect-square border-4 border-(--surface-secondary) overflow-hidden bg-(--surface-secondary) relative"
      >
        <img
          id="product-image"
          src={product.image}
          alt={product.title}
          class={`w-full h-full object-cover ${!selectedVariationInStock ? "opacity-75" : ""}`}
          loading="eager"
          fetchpriority="high"
          onerror="this.src='data:image/svg+xml,%3Csvg%20width%3D%2248%22%20height%3D%2244%22%20fill%3D%22currentColor%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20clip-rule%3D%22evenodd%22%20d%3D%22M10.6848%2043.9997L10.5924%2044C8.15681%2044%206.34269%2043.4765%205.98588%2043.3736C3.89592%2042.7665%202.69408%2041.6367%202.46029%2041.4172C2.22808%2041.1939%201.04087%2040.0543%200.394889%2037.99C-0.250828%2035.9248%200.0772527%2033.5182%200.130018%2033.1324C0.501462%2030.4075%201.41988%2028.7811%201.61449%2028.4368C2.74136%2026.4667%204.18482%2025.404%204.46431%2025.1986C4.74773%2024.9897%206.20294%2023.9167%208.45877%2023.3094C8.84197%2023.207%2010.7284%2022.7023%2013.3855%2022.7023C15.0189%2022.7023%2016.0663%2022.835%2016.2978%2022.8643C17.5905%2023.0262%2018.4266%2023.2256%2018.609%2023.2689C19.6282%2023.5121%2020.2504%2023.7659%2020.3883%2023.8222L21.7626%2024.4025C21.4805%2026.4713%2021.1984%2028.5402%2020.9163%2030.6092H16.7502C16.1771%2029.638%2015.5068%2029.258%2015.3673%2029.1789C14.5719%2028.7202%2013.8003%2028.7202%2013.6585%2028.7202C13.532%2028.7202%2012.8834%2028.7202%2012.1095%2029.0172C11.9862%2029.0653%2011.3491%2029.3141%2010.7044%2029.8806C10.5973%2029.9746%2010.0595%2030.4475%209.60157%2031.2702C9.52426%2031.4072%209.14498%2032.0802%209.00157%2033.1324C8.97362%2033.3364%208.76491%2034.8681%208.95534%2035.7051C9.1455%2036.5413%209.5684%2036.9907%209.65356%2037.0814C9.73897%2037.17%2010.1749%2037.621%2010.9844%2037.8774L11.9475%2038.0788L13.461%2038.1216C13.6869%2038.1132%2014.9172%2038.0674%2016.2769%2037.8968C21.9175%2036.9146%2023.2285%2031.5305%2023.8883%2030.093L24.0205%2029.7727C24.6673%2028.2754%2025.4694%2027.3065%2025.6288%2027.1145L25.6327%2027.1096C25.9145%2026.7511%2027.3789%2024.8884%2030.3405%2023.8202L30.5158%2023.7547C30.7535%2023.6669%2031.9742%2023.2149%2033.5866%2022.9587C33.8515%2022.917%2035.2132%2022.7023%2036.9296%2022.7023H36.9432C38.6518%2022.7033%2039.9445%2022.9162%2040.2026%2022.9587C41.7597%2023.2151%2042.85%2023.6643%2043.0697%2023.7547C44.3804%2024.2946%2045.2221%2024.9938%2045.3874%2025.1311C45.5491%2025.2635%2046.4085%2025.9676%2047.0529%2027.128C47.6505%2028.2043%2047.8569%2029.5662%2047.8903%2029.7862C47.9311%2030.0507%2048.1202%2031.2807%2047.8817%2033.1324C47.5011%2036.0868%2046.4767%2037.7766%2046.2575%2038.1382C45.0053%2040.2163%2043.4393%2041.324%2043.1363%2041.5384C42.8367%2041.7505%2041.2678%2042.8607%2038.9342%2043.4276C38.5499%2043.5187%2036.5213%2044%2034.0255%2044C33.7661%2044%2032.4874%2044%2030.7893%2043.7785C29.2528%2043.576%2028.1605%2043.1141%2027.9442%2043.0227C26.6493%2042.4696%2025.7967%2041.7459%2025.6319%2041.6059L24.825%2040.7882C20.8256%2043.1895%2014.9423%2043.7247%2014.0492%2043.8062C13.7818%2043.8312%2012.0807%2043.9906%2010.6976%2043.9997L10.6846%2044L10.6848%2043.9997ZM34.5625%2029.0979C33.9377%2029.3141%2033.5626%2029.6171%2033.4868%2029.6782C33.0496%2030.0426%2032.8233%2030.4269%2032.7795%2030.5012L32.3344%2031.4322L32.0985%2032.3499L31.9778%2033.1324L31.8851%2033.9149L31.8689%2034.8459L32.0583%2035.7906C32.0807%2035.865%2032.2014%2036.2625%2032.5376%2036.6406C32.5979%2036.703%2032.8892%2037.0047%2033.4531%2037.2342C33.5631%2037.2777%2034.0307%2037.4636%2034.9167%2037.4636C35.8025%2037.4636%2036.3142%2037.2762%2036.4289%2037.2342C37.0688%2037.005%2037.4434%2036.7027%2037.5205%2036.6406C37.9732%2036.2627%2038.2009%2035.8675%2038.2453%2035.7906C38.5316%2035.3172%2038.6656%2034.9248%2038.6925%2034.8459L38.9302%2033.9149L39.0645%2033.1324L39.1436%2032.3499L39.158%2031.4322C39.1528%2031.3565%2039.1256%2030.9611%2038.9665%2030.5012C38.9433%2030.4281%2038.8213%2030.0423%2038.4697%2029.6782C38.4091%2029.6153%2038.1176%2029.3138%2037.5382%2029.0979C37.4298%2029.0538%2036.9743%2028.8687%2036.0888%2028.8687C35.2027%2028.8687%2034.6785%2029.0564%2034.5625%2029.0979ZM14.6691%2017.1565C18.2255%2017.1565%2020.2342%2015.9174%2020.6428%2015.28H23.018C22.7445%2017.2861%2022.471%2019.2919%2022.1975%2021.2977H3.18072C3.45421%2019.2919%203.7277%2017.2861%204.00119%2015.28L5.86912%2014.9334C6.25728%2012.0863%206.64544%209.23915%207.0336%206.39226L5.26049%206.04544C5.53502%204.03046%205.80982%202.01523%206.08462%200H25.1014C24.8279%202.00607%2024.5544%204.01187%2024.2809%206.01794H21.9909C21.6766%205.48319%2019.6622%204.14123%2016.4438%204.14123C16.2178%205.79742%2015.9921%207.45361%2015.7662%209.1098C17.2295%208.80932%2018.6928%208.5091%2020.1561%208.20862C19.933%209.84469%2019.71%2011.4808%2019.4869%2013.1171C18.1056%2012.8166%2016.7241%2012.5161%2015.3428%2012.2157C15.1181%2013.8627%2014.8935%2015.5097%2014.6691%2017.1565ZM36.497%2016.0893C37.1229%2016.0979%2042.4485%2016.1718%2044.0782%2014.1986H46.4733C46.1507%2016.5649%2045.8281%2018.9313%2045.5055%2021.2977H23.6344C23.9079%2019.2919%2024.1814%2017.2861%2024.4549%2015.28L26.3228%2014.9334C26.711%2012.0863%2027.0991%209.23915%2027.4873%206.39226L25.7179%206.01769C25.9913%204.01187%2026.2648%202.00607%2026.5383%200H40.5116C40.2381%202.00607%2039.9646%204.01187%2039.6911%206.01769L37.8193%206.39226C37.3786%209.62443%2036.9377%2012.8568%2036.497%2016.0893Z%22%2F%3E%3C%2Fsvg%3E'"
        />

        {/* Out of stock overlay */}
        {
          !selectedVariationInStock && (
            <div
              id="stock-overlay"
              class="absolute top-0 left-0 bg-state-error-surface text-state-error-text px-3 py-2 text-md font-bold rounded-sm"
            >
              Sold Out
            </div>
          )
        }
      </div>

      <!-- Product Info -->
      <div class="product-info mt-4 xl:mt-8">
        <h1
          class="flex flex-col font-display font-bold text-5xl lg:text-6xl xl:text-7xl 2xl:text-8xl leading-[0.8] text-(--content-heading) text-balance"
        >
          <!-- Brand display -->
          {
            product.brand && (
              <span class="text-xl font-normal uppercase">{product.brand}</span>
            )
          }
          {product.title}
        </h1>

        <!-- Price Display -->
        <div class="mt-2">
          <h2
            id="price-display"
            class="text-4xl xl:text-5xl font-display font-bold text-(--content-emphasis)"
          >
            {formattedPrice}
            {/* Unit display */}
            {
              unitDisplay && (
                <span class="text-xl" id="unit-display">
                  {unitDisplay}
                </span>
              )
            }
          </h2>
          <small class="italic"
            >Shipping &amp; taxes are calculated at checkout</small
          >
        </div>

        <!-- Dynamic Attribute Selectors -->
        {
          hasMultipleVariations &&
            attributeTypes
              .filter(
                (attributeType) =>
                  availableAttributes[attributeType]?.length > 1
              )
              .map((attributeType) => {
                const attributeValues = availableAttributes[attributeType];
                const displayName = getAttributeDisplayName(attributeType);

                return (
                  <div class="mt-6">
                    <label
                      for="quantity-input"
                      class="text-sm font-medium block mb-1"
                    >
                      {displayName}
                    </label>
                    <div class="flex flex-wrap gap-2">
                      {attributeValues.map((value) => {
                        const isAvailable = variations.some((variation) => {
                          if (!variation.attributes || !variation.inStock)
                            return false;
                          return variation.attributes[attributeType] === value;
                        });

                        return (
                          <button
                            type="button"
                            data-attribute-type={attributeType}
                            data-attribute-value={value}
                            class:list={[
                              "px-2.5 py-1.5 border rounded-[4px] attribute-button",
                              "bg-(--ui-input-surface) text-(--ui-input-text) border-(--ui-input-border)/50",
                              !isAvailable && "opacity-50",
                            ]}
                            disabled={!isAvailable}
                          >
                            {value}
                          </button>
                        );
                      })}
                    </div>
                  </div>
                );
              })
        }

        <!-- Single attribute display (when not varying) -->
        {
          attributeTypes
            .filter(
              (attributeType) =>
                availableAttributes[attributeType]?.length === 1
            )
            .map((attributeType) => {
              const attributeValues = availableAttributes[attributeType];
              const displayName = getAttributeDisplayName(attributeType);

              return (
                <div class="mt-4">
                  <label
                    for="quantity-input"
                    class="text-sm font-medium block mb-1"
                  >
                    {displayName}
                  </label>
                  <div class="inline-block px-4 py-2 bg-(--ui-button-surface) text-(--ui-button-text) border-(--ui-button-border)/50 rounded-[4px]">
                    {attributeValues[0]}
                  </div>
                </div>
              );
            })
        }

        <!-- Fallback: Standard Variation Selection (for variations that don't have structured attributes) -->
        {
          hasMultipleVariations && attributeTypes.length === 0 && (
            <div class="mt-6">
              <h3 class="text-sm font-medium text-(--content-heading) mb-2">
                Options
              </h3>
              <div id="variation-buttons" class="flex flex-wrap gap-2">
                {variations.map((variation) => (
                  <button
                    type="button"
                    data-variation-id={variation.variationId}
                    data-price={variation.price}
                    data-name={variation.name}
                    data-quantity={variation.quantity}
                    data-in-stock={variation.inStock ? "true" : "false"}
                    data-image={variation.image || ""}
                    data-unit={variation.unit || ""}
                    class:list={[
                      "px-4 py-2 border rounded-[4px]",
                      variation.variationId === defaultVariationId
                        ? "bg-(--ui-button-surface) text-(--ui-button-text) border-(--ui-button-border)/50"
                        : "bg-(--ui-input-surface) text-(--ui-input-text) border-(--ui-input-border)/50",
                      !variation.inStock && "opacity-75",
                    ]}
                    disabled={!variation.inStock}
                  >
                    {variation.name}
                  </button>
                ))}
              </div>
            </div>
          )
        }

        <!-- Quantity Input -->
        {
          selectedVariationInStock && (
            <div class="mt-6">
              <div class="flex flex-col space-y-2 items-start">
                <label for="quantity-input" class="text-sm font-medium">
                  Quantity
                </label>
                <div class="flex border border-(--ui-input-border)/50 rounded-[4px] overflow-hidden">
                  <button
                    type="button"
                    id="decrease-quantity"
                    class="w-10 h-10 flex items-center justify-center border-r border-(--ui-input-border)/50 bg-(--ui-input-surface) text-(--ui-input-text)"
                    disabled={true}
                  >
                    -
                  </button>
                  <input
                    type="number"
                    id="quantity-input"
                    min="1"
                    max={selectedVariationQuantity}
                    value="1"
                    class="w-14 h-10 text-center bg-(--ui-input-surface) text-(--ui-input-text) [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                  />
                  <button
                    type="button"
                    id="increase-quantity"
                    class="w-10 h-10 flex items-center justify-center border-l border-(--ui-input-border)/50 bg-(--ui-input-surface) text-(--ui-input-text)"
                    disabled={selectedVariationQuantity <= 1}
                  >
                    +
                  </button>
                </div>
                <div id="availability-indicator" class="text-sm">
                  <span class="text-(--content-meta)" id="remaining-count">
                    {selectedVariationQuantity} available
                  </span>
                  <span id="cart-quantity" class="ml-1 hidden">
                    ( 0 in cart )
                  </span>
                </div>
              </div>
            </div>
          )
        }

        <!-- Hidden data for JavaScript -->
        <input
          type="hidden"
          id="variation-data"
          value={JSON.stringify({
            variations: variations,
            availableAttributes: availableAttributes,
            selectedVariationId: defaultVariationId,
            productId: product.id,
          })}
        />

        <!-- Enhanced Add to Cart Button with Loading States -->
        <div class="mt-4">
          <Button
            type="button"
            variant="primary"
            size="lg"
            classes="w-full md:w-auto"
            loading={false}
            loadingText="Adding to Cart..."
            data-product={JSON.stringify({
              id: product.id,
              catalogObjectId: product.catalogObjectId,
              variationId: defaultVariationId,
              title: product.title,
              price: selectedVariation?.price || product.price,
              image: product.image,
              unit: unitDisplay,
              variationName: selectedVariation?.name || "",
            })}
            id="add-to-cart-button"
            disabled={!selectedVariationInStock}
          >
            {selectedVariationInStock ? "Add to Cart" : "Sold Out"}
          </Button>
        </div>

        <!-- Store Information -->
        <div class="text-sm flex flex-col mt-4 space-y-1 py-2">
          <span class="italic">Available for pick up at El Camino</span>
          <button
            id="location-hours-link"
            class="relative inline-flex self-start font-semibold hover:text-ui-nav-hover before:absolute before:-bottom-0.5 before:left-0 before:w-full before:h-0.5 before:bg-(--ui-nav-hover) before:transform before:scale-x-0 before:origin-right before:transition-transform before:duration-300 before:ease-in-out hover:before:scale-x-100 hover:before:origin-left"
            type="button"
          >
            Store Location &amp; Hours
          </button>
        </div>

        <!-- Product Description -->
        {
          product.description && (
            <div class="mt-6 max-w-[52ch]">
              <div id="description-container">
                <p
                  id="product-description"
                  class="text-base text-(--content-body) line-clamp-2 text-pretty transition-all duration-300 ease-in-out"
                >
                  {product.description}
                </p>
                <button
                  id="description-toggle"
                  type="button"
                  class="mt-2 text-sm font-semibold relative inline-flex self-start hover:text-ui-nav-hover before:absolute before:-bottom-0.5 before:left-0 before:w-full before:h-0.5 before:bg-(--ui-nav-hover) before:transform before:scale-x-0 before:origin-right before:transition-transform before:duration-300 before:ease-in-out hover:before:scale-x-100 hover:before:origin-left hidden"
                >
                  <span id="toggle-text">Read more</span>
                </button>
              </div>
            </div>
          )
        }
      </div>
    </div>
  </section>
  <Modal />
</Layout>

<script>
  import { PDPController } from "@/lib/product/pdpController";
  import { processSquareError, logError } from "@/lib/square/errorUtils";

  let pdpController: PDPController | null = null;

  /**
   * Initialize controller from DOM data - with resilient error handling
   */
  function initializePDP(): boolean {
    const dataInput = document.getElementById(
      "variation-data"
    ) as HTMLInputElement;
    if (!dataInput?.value) return false;

    // Clean up existing controller to prevent double event binding
    if (pdpController) {
      pdpController.cleanup();
      pdpController = null;
    }

    try {
      const productData = JSON.parse(dataInput.value);

      // Check if we have the minimum required elements for PDP controller
      const hasAttributeButtons =
        document.querySelectorAll(".attribute-button").length > 0;
      const hasVariationButtons =
        document.querySelectorAll("[data-variation-id]").length > 0;
      const hasQuantityControls =
        document.getElementById("quantity-input") !== null;

      // Only initialize PDP controller if we have interactive elements that need it
      if (hasAttributeButtons || hasVariationButtons || hasQuantityControls) {
        console.log("Initializing PDP controller...");
        console.log("Has attribute buttons:", hasAttributeButtons);
        console.log("Has variation buttons:", hasVariationButtons);
        console.log("Has quantity controls:", hasQuantityControls);
        console.log("Product data:", productData);

        pdpController = new PDPController(productData);
        console.log("PDP controller created:", pdpController);
        return true;
      } else {
        console.log("No interactive elements found - not initializing PDP");
        return true; // This is OK, not an error
      }
    } catch (error) {
      const appError = processSquareError(error, "initializePDP");
      logError(appError);
      console.log(
        "PDP controller failed to initialize, but page will continue working"
      );
      return true; // Don't fail the whole page for this
    }
  }

  /**
   * Initialize product description read more/less functionality - CSS override fix
   */
  function initializeDescriptionToggle(): void {
    const container = document.getElementById("description-container");
    const description = document.getElementById("product-description");
    const toggleButton = document.getElementById("description-toggle");
    const toggleText = document.getElementById("toggle-text");

    if (!container || !description || !toggleButton || !toggleText) return;

    const textContent = description.textContent || "";

    // Force hide with inline style instead of class (overrides CSS specificity)
    toggleButton.style.display = "none";

    // Only show if text is long enough
    if (textContent.length > 120) {
      toggleButton.style.display = "inline-flex";

      let isExpanded = false;

      toggleButton.addEventListener("click", () => {
        if (isExpanded) {
          description.classList.add("line-clamp-2");
          toggleText.textContent = "Read more";
          isExpanded = false;
        } else {
          description.classList.remove("line-clamp-2");
          toggleText.textContent = "Read less";
          isExpanded = true;
        }
      });
    }
  }

  /**
   * ✅ ASTRO VIEW TRANSITIONS: Initialize on page load
   */
  // Run immediately since view transitions are disabled
  function initializePage() {
    console.log("Page initialization started");

    const variationDataElement = document.getElementById("variation-data");
    const isProductPage = variationDataElement !== null;

    console.log("variation-data element found:", variationDataElement);
    console.log("isProductPage:", isProductPage);

    if (isProductPage) {
      console.log("Product page detected, calling initializePDP()");
      if (!initializePDP()) {
        console.error("Failed to initialize PDP controller");
      }
    } else {
      console.log("Not a product page, skipping PDP initialization");
    }

    initializeDescriptionToggle();
  }

  // Run on DOM ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initializePage);
  } else {
    initializePage();
  }

  // Also handle view transitions when re-enabled
  document.addEventListener("astro:page-load", initializePage);

  /**
   * ✅ ASTRO VIEW TRANSITIONS: Clean up on navigation
   */
  document.addEventListener("astro:after-swap", () => {
    pdpController?.cleanup();
    pdpController = null;
  });
</script>
