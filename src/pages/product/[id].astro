---
import Layout from "@/layouts/Layout.astro";
import Button from "@/components/Button.astro";
import { fetchProduct } from "@/lib/square/client";
import { MoneyUtils } from "@/lib/square/money";
import { cart } from "@/lib/cart";

const { id } = Astro.params;
const product = id ? await fetchProduct(id) : null;

if (!product) {
  return Astro.redirect("/404");
}

const formattedPrice = product.price.toFixed(2); // Using number directly
---

<Layout title={product.title}>
  <!-- Rest of the template stays the same -->
  <div class="pt-4">
    <Button
      type="button"
      variant="primary"
      size="lg"
      classes="w-full md:w-auto"
      data-product-id={product.id}
      data-catalog-id={product.catalogObjectId}
      data-variation-id={product.variationId}
      data-price={product.price}
    >
      Add to Cart
    </Button>
  </div>

  <script>
    import { cart } from "@/lib/cart";

    document
      .querySelector("[data-product-id]")
      ?.addEventListener("click", (e) => {
        const button = e.target as HTMLButtonElement;
        const productId = button.dataset.productId;
        const catalogId = button.dataset.catalogId;
        const variationId = button.dataset.variationId;
        const price = parseFloat(button.dataset.price || "0");

        if (productId && catalogId && variationId) {
          const title = document.querySelector("h1")?.textContent?.trim() || "";
          const image =
            document.querySelector("img")?.getAttribute("src") || "";

          cart.addItem({
            id: productId,
            catalogObjectId: catalogId,
            variationId: variationId,
            title: title,
            price: price, // Keep as number for now
            quantity: 1,
            image: image,
          });

          // Show success message
          const successMessage = document.createElement("div");
          successMessage.className =
            "fixed top-4 right-4 bg-fig-leaf-500 dark:bg-sweet-tea-300 text-beeswax-50 dark:text-fig-leaf-900 px-4 py-2 rounded-lg shadow-lg";
          successMessage.textContent = "Added to cart";
          document.body.appendChild(successMessage);

          setTimeout(() => {
            successMessage.remove();
          }, 2000);
        }
      });
  </script></Layout
>
