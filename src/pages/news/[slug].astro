---
import Layout from '@/layouts/Layout.astro'
import BlogPost from '@/components/blog/BlogPost.astro'
import { getBlogPost } from '@/lib/payload/blog'
import { getSEODataFromBlogPost } from '@/lib/payload/seo'
import { generateBlogPostSchema } from '@/lib/payload/structured-data'
import type { BlogPost as BlogPostType } from '@/lib/types'

const { slug } = Astro.params

let post: BlogPostType | null = null;

try {
  post = await getBlogPost(slug as string);
  if (!post) {
    console.log('Post not found:', slug);
    return Astro.redirect('/404');
  }
  
  if (post.status !== 'published') {
    console.log('Post not published:', slug);
    return Astro.redirect('/404');
  }
} catch (error: any) {
  console.error('Error fetching post:', error);
  return Astro.redirect('/500');
}

let seoData;
let structuredData;

try {
  seoData = await getSEODataFromBlogPost(post);
  structuredData = generateBlogPostSchema(post);
} catch (error: any) {
  console.error('Error generating metadata:', error);
  // Fallback to basic metadata
  seoData = { 
    title: post.title,
    description: post.excerpt,
    openGraph: {
      basic: {
        title: post.title,
        type: 'article',
        image: post.featuredImage.url,
      }
    }
  };
  structuredData = {};
}
---

<Layout seo={seoData} structuredData={structuredData}>
  <div class="w-full max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
    <BlogPost post={post} />
  </div>
</Layout>