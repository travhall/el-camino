---
// src/pages/order-confirmation.astro
import Layout from "@/layouts/Layout.astro";
import { squareClient } from "@/lib/square/client";
import { MoneyUtils } from "@/lib/square/money";
import type { OrderLineItem } from "square";
import { cart } from "@/lib/cart";

const { searchParams } = Astro.url;
const orderId = searchParams.get("orderId");

let orderDetails = null;
let error = null;

if (orderId) {
  try {
    const { result } = await squareClient.ordersApi.retrieveOrder(orderId);
    orderDetails = result.order;

    // Clear the cart after successful order retrieval
    if (orderDetails) {
      cart.clear();
    }
  } catch (e) {
    error = e instanceof Error ? e.message : "Failed to load order";
    console.error("Order retrieval error:", e);
  }
}
---

<Layout title="Order Confirmation">
  <div class="max-w-2xl mx-auto px-4 py-16">
    {
      error ? (
        <div class="text-center">
          <h1 class="text-3xl font-display mb-4">Oops! Something went wrong</h1>
          <p class="text-black-pearl-600 dark:text-beeswax-300 mb-8">{error}</p>
          <a
            href="/"
            class="inline-block font-sans font-semibold transition-all ease-in-out duration-300 border-2 rounded-[4px] focus-visible:ring outline-0 focus-visible:ring-offset-2 text-beeswax-50 dark:text-fig-leaf-900 bg-fig-leaf-500 dark:bg-sweet-tea-300 hover:bg-fig-leaf-500/75 hover:dark:bg-sweet-tea-300/75 border-fig-leaf-500 dark:border-sweet-tea-300 focus-visible:ring-fig-leaf-500 dark:focus-visible:ring-sweet-tea-300 focus-visible:ring-offset-sweet-tea-50 dark:focus-visible:ring-offset-fig-leaf-900 text-lg py-2 px-4"
          >
            Return to Home
          </a>
        </div>
      ) : orderDetails ? (
        <div>
          <div class="text-center mb-8">
            <h1 class="text-3xl font-display mb-4">
              Thank You for Your Order!
            </h1>
            <p class="text-black-pearl-600 dark:text-beeswax-300">
              Your order has been confirmed and will be shipped soon.
            </p>
          </div>

          <div class="bg-beeswax-50 dark:bg-black-pearl-800 rounded-lg p-6">
            <h2 class="font-display text-xl mb-4">Order Summary</h2>
            <div class="space-y-4">
              {orderDetails.lineItems?.map((item: OrderLineItem) => (
                <div class="flex justify-between">
                  <span>
                    {item.name} Ã— {item.quantity}
                  </span>
                  <span class="font-display">
                    $
                    {item.totalMoney
                      ? MoneyUtils.format(item.totalMoney)
                      : "$0.00"}
                  </span>
                </div>
              ))}
              <div class="border-t border-black-pearl-200 dark:border-black-pearl-700 pt-4 mt-4">
                <div class="flex justify-between font-bold">
                  <span>Total</span>
                  <span>
                    $
                    {orderDetails.totalMoney
                      ? MoneyUtils.format(orderDetails.totalMoney)
                      : "$0.00"}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-8 text-center">
            <p class="text-sm text-black-pearl-500 dark:text-beeswax-400 mb-4">
              Order ID: {orderId}
            </p>
            <a
              href="/"
              class="inline-block font-sans font-semibold transition-all ease-in-out duration-300 border-2 rounded-[4px] focus-visible:ring outline-0 focus-visible:ring-offset-2 text-beeswax-50 dark:text-fig-leaf-900 bg-fig-leaf-500 dark:bg-sweet-tea-300 hover:bg-fig-leaf-500/75 hover:dark:bg-sweet-tea-300/75 border-fig-leaf-500 dark:border-sweet-tea-300 focus-visible:ring-fig-leaf-500 dark:focus-visible:ring-sweet-tea-300 focus-visible:ring-offset-sweet-tea-50 dark:focus-visible:ring-offset-fig-leaf-900 text-lg py-2 px-4"
            >
              Continue Shopping
            </a>
          </div>
        </div>
      ) : (
        <div class="text-center">
          <h1 class="text-3xl font-display mb-4">Order Not Found</h1>
          <p class="text-black-pearl-600 dark:text-beeswax-300 mb-8">
            We couldn't find the order you're looking for.
          </p>
          <a
            href="/"
            class="inline-block font-sans font-semibold transition-all ease-in-out duration-300 border-2 rounded-[4px] focus-visible:ring outline-0 focus-visible:ring-offset-2 text-beeswax-50 dark:text-fig-leaf-900 bg-fig-leaf-500 dark:bg-sweet-tea-300 hover:bg-fig-leaf-500/75 hover:dark:bg-sweet-tea-300/75 border-fig-leaf-500 dark:border-sweet-tea-300 focus-visible:ring-fig-leaf-500 dark:focus-visible:ring-sweet-tea-300 focus-visible:ring-offset-sweet-tea-50 dark:focus-visible:ring-offset-fig-leaf-900 text-lg py-2 px-4"
          >
            Return to Home
          </a>
        </div>
      )
    }
  </div>
</Layout>
