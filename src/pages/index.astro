---
// src/pages/index.astro - Updated with featured article priority
import Layout from "@/layouts/Layout.astro";
import ArticleGrid from "@/components/ArticleGrid.astro";
import { getNewsPagePosts } from "@/lib/wordpress/api";
import type { WordPressPost } from "@/lib/wordpress/types";

let posts: WordPressPost[] = [];
let error: string | null = null;

try {
  const newsData = await getNewsPagePosts();
  const { featuredPost, regularPosts } = newsData;

  // HOME PAGE: Featured article first, then most recent regular posts
  if (featuredPost) {
    posts = [featuredPost, ...regularPosts.slice(0, 5)]; // Total 6 posts for home
  } else {
    posts = regularPosts.slice(0, 6); // Just most recent if no featured
  }
} catch (e) {
  error = e instanceof Error ? e.message : "An error occurred loading posts";
}

// === ISR CACHING: Enable Edge Caching for Home Page ===
// WordPress content changes less frequently than inventory
// Cache for 10 min, serve stale for 7 days while revalidating
Astro.response.headers.set('Cache-Control', 'public, max-age=0, must-revalidate');
Astro.response.headers.set('Netlify-CDN-Cache-Control', 
  'public, durable, s-maxage=600, stale-while-revalidate=604800'
);

// === LCP OPTIMIZATION: Preload first article image ===
import { EnhancedImageOptimizer } from "@/lib/image/enhanced-optimizer";
import { extractEmbeddedData } from "@/lib/wordpress/types";

const firstPost = posts[0];
const firstPostData = firstPost ? extractEmbeddedData(firstPost) : null;
const lcpImage = firstPostData?.featuredMedia?.source_url
  ? EnhancedImageOptimizer.generateOptimizedSources(firstPostData.featuredMedia.source_url, {
      width: 800,
      height: 533,
      quality: 85,
      priority: true,
    })
  : null;
---

<Layout title="Welcome Home, we're glad you're here | El Camino">
  {/* LCP PRELOAD: Load first article image with format negotiation */}
  {lcpImage && (
    <Fragment slot="head">
      {/* Preconnect to WordPress CDN for faster image loading */}
      <link rel="preconnect" href="https://elcaminoskateshop.wordpress.com" crossorigin />
      <link rel="dns-prefetch" href="https://elcaminoskateshop.wordpress.com" />
      
      {/* OPTIMIZATION: Preload display font for article titles */}
      <link
        rel="preload"
        href="/fonts/AlumniSans.woff2"
        as="font"
        type="font/woff2"
        crossorigin="anonymous"
      />
      
      {/* Preload AVIF (best compression) if available */}
      {lcpImage.avif && (
        <link
          rel="preload"
          href={lcpImage.avif}
          as="image"
          type="image/avif"
          fetchpriority="high"
        />
      )}
      {/* Fallback to WebP if AVIF not available */}
      {!lcpImage.avif && lcpImage.webp && (
        <link
          rel="preload"
          href={lcpImage.webp}
          as="image"
          type="image/webp"
          fetchpriority="high"
        />
      )}
      {/* JPEG fallback */}
      {!lcpImage.avif && !lcpImage.webp && lcpImage.jpeg && (
        <link
          rel="preload"
          href={lcpImage.jpeg}
          as="image"
          type="image/jpeg"
          fetchpriority="high"
        />
      )}
    </Fragment>
  )}

  <section>
    <ArticleGrid posts={posts} error={error} showSidebar={true} />
  </section>
</Layout>
